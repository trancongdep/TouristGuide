<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HDV Du L·ªãch v2.4</title>
    <meta name="theme-color" content="#212529">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; background-color: #f8f9fa; color: #333;
            display: flex; flex-direction: column; height: 100vh;
        }
        
        /* DASHBOARD */
        #dashboard-container {
            background: #212529; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1001; flex-shrink: 0;
        }

        #speed-panel {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 15px; border-bottom: 1px solid #444;
        }
        #speed-panel.warning { background: #dc3545; animation: flash 1s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .speed-box { text-align: center; width: 80px; }
        .speed-value { font-size: 1.8rem; font-weight: bold; font-variant-numeric: tabular-nums; line-height: 1; }
        .speed-label { font-size: 0.7rem; text-transform: uppercase; color: #adb5bd; }
        
        .limit-circle {
            width: 55px; height: 55px;
            border-radius: 50%; border: 4px solid #dc3545;
            background: white; color: #333;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.4rem; position: relative;
        }
        .limit-circle::after { content: "LIMIT"; position: absolute; bottom: 4px; font-size: 0.5rem; color: #666; }

        #vehicle-trigger {
            cursor: pointer; border: 1px solid #444; border-radius: 8px; padding: 5px;
            background: #343a40; transition: background 0.2s;
        }
        #vehicle-trigger:active { background: #495057; }

        #nav-panel {
            background: #343a40; padding: 10px 15px; display: none;
            align-items: center; border-bottom: 1px solid #444;
        }
        #nav-icon { font-size: 2rem; margin-right: 15px; min-width: 40px; text-align: center; }
        #nav-text { flex: 1; }
        .nav-instruction { font-size: 1.1rem; font-weight: bold; color: #fff; line-height: 1.2;}
        .nav-distance { font-size: 0.9rem; color: #ffc107; font-weight: bold; }

        #story-panel {
            background: #fff3cd; color: #856404; padding: 10px 15px; font-size: 0.95rem;
            display: none; align-items: center; border-bottom: 1px solid #ffeeba;
        }
        .story-icon { margin-right: 10px; animation: pulse 1s infinite; font-size: 1.2rem;}

        /* SETTINGS AREA */
        .controls { background: white; padding: 0; border-bottom: 1px solid #ddd; overflow: hidden; }
        #settings-area { padding: 10px; display: block; }
        
        .vehicle-selector { display: flex; background: #e9ecef; border-radius: 6px; padding: 3px; margin-bottom: 8px; }
        .vehicle-option { flex: 1; text-align: center; padding: 6px; cursor: pointer; border-radius: 4px; font-weight: 500; }
        .vehicle-option.active { background: white; color: #0d6efd; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-weight: bold; }

        .input-group { display: flex; gap: 5px; margin-bottom: 8px; }
        input { flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem;}
        
        .action-group { display: flex; gap: 10px; }
        button.action-btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1; font-size: 1rem; color: white; }
        .btn-go { background-color: #198754; }
        .btn-quit { background-color: #dc3545; display: none; margin-top: 10px; width: 100%; }

        /* Audio Controls */
        #audio-controls { padding: 10px; display: none; text-align: center; background: white; border-top: 1px solid #eee; }
        .btn-audio { 
            background-color: #0d6efd; color: white; width: 100%; padding: 12px; 
            border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; 
        }
        .btn-audio.stop { background-color: #dc3545; }

        #status { font-size: 0.8rem; color: #666; margin-top: 5px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 10px 5px;}

        /* MAIN CONTENT */
        #main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        #map { height: 60%; width: 100%; background: #e5e3df; transition: height 0.3s; }
        #places-list { 
            height: 40%; overflow-y: auto; padding: 0; list-style: none; margin: 0; 
            background: #f8f9fa; position: relative;
        }
        #places-list:empty::before {
            content: "üì° ƒêang qu√©t t√¨m ƒë·ªãa ƒëi·ªÉm...";
            display: flex; justify-content: center; align-items: center;
            height: 100%; color: #adb5bd; font-style: italic; font-size: 0.9rem; background: #f8f9fa;
        }

        .place-card { background: white; padding: 12px 15px; border-bottom: 1px solid #dee2e6; border-left: 4px solid transparent; }
        .place-card.priority { border-left-color: #a73b24; background: #fffdfd; }
        .place-card.active { background-color: #ffeeba; border-left-color: #ffc107; }
        .place-card.read { opacity: 0.6; background-color: #f0f0f0; border-left-color: #ccc; } /* Style cho b√†i ƒë√£ ƒë·ªçc */
        
        .place-title { font-weight: bold; font-size: 1rem; color: #212529; }
        .place-badge { font-size: 0.7rem; background: #a73b24; color: white; padding: 2px 5px; border-radius: 3px; display: none; }
        .place-card.priority .place-badge { display: inline-block; }
        .place-desc { font-size: 0.85rem; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-top: 4px;}

        footer { background-color: #e9ecef; color: #6c757d; text-align: center; padding: 8px; font-size: 0.75rem; border-top: 1px solid #dee2e6; flex-shrink: 0; }
        
    </style>
</head>
<body>

<div id="dashboard-container">
    <div id="speed-panel">
        <div class="speed-box">
            <span class="speed-value" id="current-speed">0</span>
            <span class="speed-label">km/h</span>
        </div>
        <div class="limit-circle"><span id="speed-limit">50</span></div>
        
        <div class="speed-box" id="vehicle-trigger" onclick="toggleSettingsMenu()">
            <span class="speed-value" style="font-size: 1.2rem;" id="vehicle-icon">üöó</span>
            <span class="speed-label" id="vehicle-label">C√†i ƒë·∫∑t</span>
        </div>
    </div>

    <div id="nav-panel">
        <div id="nav-icon">‚¨ÜÔ∏è</div>
        <div id="nav-text">
            <span class="nav-instruction" id="nav-instruction"></span>
            <span class="nav-distance" id="nav-distance"></span>
        </div>
    </div>

    <div id="story-panel">
        <span class="story-icon">üó£Ô∏è</span>
        <span id="story-text">ƒêang thuy·∫øt minh...</span>
    </div>
</div>

<div class="controls">
    <div id="settings-area">
        <div class="vehicle-selector">
            <div class="vehicle-option active" onclick="setVehicle('car')" id="opt-car">üöó √î t√¥</div>
            <div class="vehicle-option" onclick="setVehicle('bike')" id="opt-bike">üèçÔ∏è Xe m√°y</div>
        </div>
        <div class="input-group">
            <input type="text" id="destination-input" placeholder="Nh·∫≠p ƒëi·ªÉm ƒë·∫øn (VD: H·ªì G∆∞∆°m)">
        </div>
        <div class="action-group">
            <button class="action-btn btn-go" onclick="startApp()">üöÄ B·∫Øt ƒë·∫ßu</button>
        </div>
        <button class="action-btn btn-quit" id="btn-quit" onclick="stopApp()">‚èπ K·∫øt th√∫c h√†nh tr√¨nh</button>
    </div>

    <div id="audio-controls">
        <button class="btn-audio" id="btn-audio-toggle" onclick="toggleAudio()">üîä B·∫≠t thuy·∫øt minh</button>
    </div>
    <div id="status">S·∫µn s√†ng...</div>
</div>

<div id="main-content">
    <div id="map"></div>
    <ul id="places-list"></ul>
</div>

<footer>Copyright TCDsoft @2025 - version 2.4</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  const firebaseConfig = {
    apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
    authDomain: "tavietnam-78ae8.firebaseapp.com",
    projectId: "tavietnam-78ae8",
    storageBucket: "tavietnam-78ae8.firebasestorage.app",
    messagingSenderId: "670121705534",
    appId: "1:670121705534:web:1027ad98550573ad37116f"
  };
  const app = initializeApp(firebaseConfig);
  console.log("App v2.4 Initialized");
</script>

<script>
    const map = L.map('map').setView([10.8231, 106.6297], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let userMarker, destMarker, routePolyline;
    let currentLat, currentLon;
    let synth = window.speechSynthesis;
    
    let isRunning = false;
    let isNavigating = false; 
    let vehicleType = 'car';
    
    // NAV DATA
    let routeSteps = [];
    let nextStepIndex = 0;
    
    // TOUR GUIDE DATA
    let placesQueue = []; // Danh s√°ch hi·ªÉn th·ªã & ch·ªù ƒë·ªçc
    let alreadyReadIds = []; // Danh s√°ch ƒëen (ƒê√£ ƒë·ªçc)
    let lastScanLat = 0, lastScanLon = 0;
    let isPausedByUser = false; // Ng∆∞·ªùi d√πng ch·ªß ƒë·ªông t·∫Øt ti·∫øng
    
    const elSpeed = document.getElementById('current-speed');
    const elLimit = document.getElementById('speed-limit');
    const elNavPanel = document.getElementById('nav-panel');
    const elStoryPanel = document.getElementById('story-panel');
    const elStoryText = document.getElementById('story-text');
    const listEl = document.getElementById('places-list');
    
    const divSettings = document.getElementById('settings-area');
    const divAudio = document.getElementById('audio-controls');
    const btnAudio = document.getElementById('btn-audio-toggle');
    const btnQuit = document.getElementById('btn-quit');

    const DEFAULT_LIMIT_CAR = 50;
    const DEFAULT_LIMIT_BIKE = 40;
    const PRIORITY_KEYWORDS = ['ch√πa', 'ƒë√¨nh', 'ƒë·ªÅn', 'mi·∫øu', 'nh√† th·ªù', 'di t√≠ch', 'l·ªãch s·ª≠', 'b·∫£o t√†ng', 'lƒÉng', 'vƒÉn mi·∫øu', 'dinh', 'c√¥ng vi√™n'];

    function setVehicle(type) {
        vehicleType = type;
        document.getElementById('opt-car').className = `vehicle-option ${type==='car'?'active':''}`;
        document.getElementById('opt-bike').className = `vehicle-option ${type==='bike'?'active':''}`;
        document.getElementById('vehicle-icon').innerText = type==='car'?'üöó':'üèçÔ∏è';
        updateSpeedLimitDisplay(null); 
    }
    
    function updateStatus(msg) { document.getElementById('status').innerText = msg; }

    function toggleSettingsMenu() {
        if (isRunning) {
            if (divSettings.style.display === 'none') {
                divSettings.style.display = 'block'; divAudio.style.display = 'none';
            } else {
                divSettings.style.display = 'none'; divAudio.style.display = 'block';
            }
        }
    }

    function toggleAudio() {
        if (synth.speaking) {
            // ƒêang ƒë·ªçc -> T·∫Øt
            synth.cancel();
            isPausedByUser = true; // Ghi nh·ªõ l√† ng∆∞·ªùi d√πng mu·ªën im l·∫∑ng
            updateAudioButton(false);
            elStoryPanel.style.display = 'none';
        } else {
            // ƒêang t·∫Øt -> B·∫≠t
            isPausedByUser = false;
            updateAudioButton(true);
            playNextStory(); // K√≠ch ho·∫°t chu·ªói ƒë·ªçc
        }
    }

    function updateAudioButton(isSpeakingState) {
        if (isSpeakingState) {
            btnAudio.innerText = "üîá D·ª´ng thuy·∫øt minh";
            btnAudio.className = "btn-audio stop";
        } else {
            btnAudio.innerText = "üîä B·∫≠t thuy·∫øt minh";
            btnAudio.className = "btn-audio";
        }
    }

    async function startApp() {
        const destInput = document.getElementById('destination-input').value.trim();
        isRunning = true;
        isPausedByUser = false; // M·∫∑c ƒë·ªãnh b·∫≠t ti·∫øng
        
        divSettings.style.display = 'none';
        divAudio.style.display = 'block';
        btnQuit.style.display = 'block';
        updateAudioButton(true);

        placesQueue = [];
        alreadyReadIds = [];
        listEl.innerHTML = ""; 

        if (destInput) {
            await setupNavigation(destInput);
        } else {
            isNavigating = false;
            elNavPanel.style.display = 'none';
            if (currentLat) {
                map.setView([currentLat, currentLon], 15);
                scanSurroundings(currentLat, currentLon);
            }
            speak("Ch·∫ø ƒë·ªô t·ª± do. T√¥i s·∫Ω l·∫ßn l∆∞·ª£t ƒë·ªçc c√°c ƒë·ªãa ƒëi·ªÉm t√¨m th·∫•y.", true);
        }
    }

    function stopApp() {
        isRunning = false; isNavigating = false; synth.cancel();
        divSettings.style.display = 'block';
        divAudio.style.display = 'none';
        btnQuit.style.display = 'none';
        elNavPanel.style.display = 'none';
        elStoryPanel.style.display = 'none';
        updateStatus("ƒê√£ d·ª´ng.");
    }

    function initLocation() {
        if (!navigator.geolocation) return updateStatus("L·ªói GPS");
        
        navigator.geolocation.watchPosition(
            (pos) => {
                currentLat = pos.coords.latitude;
                currentLon = pos.coords.longitude;
                const speedKmh = Math.round((pos.coords.speed || 0) * 3.6);
                
                if (!userMarker) {
                    userMarker = L.marker([currentLat, currentLon], {zIndexOffset: 1000}).addTo(map);
                    map.setView([currentLat, currentLon], 16);
                } else {
                    userMarker.setLatLng([currentLat, currentLon]);
                }
                
                elSpeed.innerText = speedKmh;

                if (isRunning) {
                    checkSpeedLimit(speedKmh, currentLat, currentLon);

                    let navIsBusy = false;
                    if (isNavigating) navIsBusy = processNavigation(currentLat, currentLon);
                    
                    // N·∫øu kh√¥ng b·∫≠n d·∫´n ƒë∆∞·ªùng, check xem c√≥ c·∫ßn qu√©t th√™m ƒë·ªãa ƒëi·ªÉm kh√¥ng
                    if (!navIsBusy) processTourGuideScan(currentLat, currentLon);
                }
            },
            (err) => console.error(err),
            { enableHighAccuracy: true, maximumAge: 1000 }
        );
    }
    initLocation();

    // --- NAVIGATION LOGIC ---
    async function setupNavigation(query) {
        updateStatus("ƒêang t√¨m ƒë∆∞·ªùng...");
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=vn&limit=1`);
        const data = await res.json();
        if (data.length === 0) { stopApp(); return alert("Kh√¥ng t√¨m th·∫•y!"); }
        
        const dest = data[0];
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker([dest.lat, dest.lon]).addTo(map).bindPopup("ƒê√≠ch").openPopup();

        const url = `https://router.project-osrm.org/route/v1/driving/${currentLon},${currentLat};${dest.lon},${dest.lat}?overview=full&geometries=geojson&steps=true`;
        const routeRes = await fetch(url);
        const routeData = await routeRes.json();
        if (routeData.code !== 'Ok') { stopApp(); return alert("L·ªói ƒë∆∞·ªùng ƒëi!"); }

        const route = routeData.routes[0];
        routeSteps = route.legs[0].steps;
        nextStepIndex = 1;
        isNavigating = true;
        elNavPanel.style.display = 'flex';

        const latLngs = route.geometry.coordinates.map(c => [c[1], c[0]]);
        if (routePolyline) map.removeLayer(routePolyline);
        routePolyline = L.polyline(latLngs, {color: '#0d6efd', weight: 6}).addTo(map);
        map.fitBounds(routePolyline.getBounds());

        updateStatus("ƒêang t·∫£i d·ªØ li·ªáu thuy·∫øt minh...");
        await scanRouteSamples(latLngs);
        
        // K√≠ch ho·∫°t chu·ªói ƒë·ªçc ngay l·∫≠p t·ª©c
        playNextStory();
        
        speak(`B·∫Øt ƒë·∫ßu ƒëi ƒë·∫øn ${dest.display_name.split(',')[0]}.`, true);
    }

    async function scanRouteSamples(pathCoords) {
        const samplePoints = [];
        const step = Math.floor(pathCoords.length / 15) || 1; 
        for(let i=0; i<pathCoords.length; i+=step) samplePoints.push({lat: pathCoords[i][0], lon: pathCoords[i][1]});
        samplePoints.push({lat: pathCoords[pathCoords.length-1][0], lon: pathCoords[pathCoords.length-1][1]});
        
        const scanPromises = samplePoints.slice(0, 10).map(pt => scanSurroundings(pt.lat, pt.lon));
        await Promise.all(scanPromises);
    }

    function processNavigation(lat, lon) {
        if (!routeSteps || nextStepIndex >= routeSteps.length) return false;
        const nextStep = routeSteps[nextStepIndex];
        const stepLoc = nextStep.maneuver.location;
        const dist = getDist(lat, lon, stepLoc[1], stepLoc[0]);
        document.getElementById('nav-distance').innerText = dist < 1000 ? Math.round(dist)+"m" : (dist/1000).toFixed(1)+"km";
        
        let instruction = "ƒêi th·∫≥ng";
        let icon = "‚¨ÜÔ∏è";
        const modifier = nextStep.maneuver.modifier;
        if (nextStep.maneuver.type === 'turn') {
            if (modifier && modifier.includes('right')) { icon = "‚û°Ô∏è"; instruction = "R·∫Ω ph·∫£i"; }
            if (modifier && modifier.includes('left')) { icon = "‚¨ÖÔ∏è"; instruction = "R·∫Ω tr√°i"; }
        } else if (nextStep.maneuver.type === 'arrive') { icon = "üèÅ"; instruction = "ƒê·∫øn ƒë√≠ch"; }

        document.getElementById('nav-instruction').innerText = instruction;
        document.getElementById('nav-icon').innerText = icon;

        if (dist < 30) { nextStepIndex++; return true; } 
        if (dist < 100 && dist > 80 && !synth.speaking) { speak(`S·∫Øp ${instruction}.`, true); return true; } 
        return false; 
    }

    // --- CONTINUOUS TOUR GUIDE LOGIC ---
    function processTourGuideScan(lat, lon) {
        // Ch·ªâ qu√©t l·∫°i n·∫øu ƒëi xa > 2km
        if (getDist(lat, lon, lastScanLat, lastScanLon) > 2000) {
            scanSurroundings(lat, lon);
        }
        // Logic ph√°t √¢m thanh ƒë√£ chuy·ªÉn sang playNextStory()
        // H√†m n√†y gi·ªù ch·ªâ ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu lu√¥n ƒë∆∞·ª£c n·∫°p th√™m khi di chuy·ªÉn
        if (!synth.speaking && !isPausedByUser) {
            playNextStory();
        }
    }

    // H√†m quan tr·ªçng: ƒê·ªçc b√†i ti·∫øp theo trong h√†ng ƒë·ª£i
    function playNextStory() {
        if (synth.speaking || isPausedByUser) return;
        if (placesQueue.length === 0) return;

        // T√¨m b√†i ch∆∞a ƒë·ªçc
        // S·∫Øp x·∫øp l·∫°i danh s√°ch: ∆Øu ti√™n g·∫ßn nh·∫•t tr∆∞·ªõc, sau ƒë√≥ ƒë·∫øn ∆∞u ti√™n (Di t√≠ch)
        // Logic v2.4: ƒê·ªçc l·∫ßn l∆∞·ª£t t·∫•t c·∫£, nh∆∞ng ∆∞u ti√™n c√°i g·∫ßn ƒë·ªÉ h·ª£p ng·ªØ c·∫£nh
        
        let candidates = placesQueue.filter(p => !alreadyReadIds.includes(p.id));
        
        if (candidates.length === 0) {
            if(!synth.speaking) elStoryPanel.style.display = 'none';
            return;
        }

        // S·∫Øp x·∫øp: G·∫ßn -> Xa
        candidates.sort((a, b) => {
            const distA = getDist(currentLat, currentLon, a.lat, a.lon);
            const distB = getDist(currentLat, currentLon, b.lat, b.lon);
            return distA - distB;
        });

        const nextPlace = candidates[0]; // L·∫•y c√°i g·∫ßn nh·∫•t ch∆∞a ƒë·ªçc
        
        // Trigger ƒë·ªçc
        alreadyReadIds.push(nextPlace.id);
        
        // C·∫≠p nh·∫≠t UI: ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
        document.querySelectorAll('.place-card').forEach(e => {
            e.classList.remove('active');
            if (alreadyReadIds.includes(parseInt(e.id.replace('place-','')))) {
                e.classList.add('read');
            }
        });

        const card = document.getElementById(`place-${nextPlace.id}`);
        if(card) { 
            card.classList.add('active'); 
            card.scrollIntoView({behavior:"smooth", block:"center"}); 
        }

        elStoryPanel.style.display = 'flex';
        elStoryText.innerText = nextPlace.title;
        
        const intro = nextPlace.isPriority ? "T·∫°i ƒë√¢y c√≥ di t√≠ch. " : "ƒê·ªãa ƒëi·ªÉm ti·∫øp theo. ";
        
        // G·ªçi speak v·ªõi c·ªù isUrgent = false (ƒë·ªÉ n√≥ g·ªçi l·∫°i playNextStory khi xong)
        speak(`${intro} ${nextPlace.title}. ${nextPlace.extract}`, false);
    }

    async function scanSurroundings(lat, lon) {
        lastScanLat = lat; lastScanLon = lon;
        const url = `https://vi.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}|${lon}&gsradius=2000&gslimit=10&format=json&origin=*`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            if (!data.query || !data.query.geosearch) return;
            
            // L·ªçc tr√πng ID v√† tr√πng trong danh s√°ch ƒë√£ ƒë·ªçc (ƒë·ªÉ kh√¥ng add l·∫°i c√°i ƒë√£ ƒë·ªçc r·ªìi)
            const newPlaces = data.query.geosearch.filter(p => 
                !placesQueue.some(old => old.id === p.pageid) && 
                !alreadyReadIds.includes(p.pageid)
            );
            
            if (newPlaces.length === 0) return;

            const ids = newPlaces.map(p => p.pageid).join('|');
            const detailRes = await fetch(`https://vi.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&pageids=${ids}&format=json&origin=*`);
            const detailData = await detailRes.json();
            const pages = detailData.query.pages;

            newPlaces.forEach(p => {
                const details = pages[p.pageid];
                if (details && details.extract && details.extract.length > 30) {
                    const text = (p.title + " " + details.extract).toLowerCase();
                    const isPriority = PRIORITY_KEYWORDS.some(k => text.includes(k));
                    placesQueue.push({ id: p.pageid, title: p.title, lat: p.lat, lon: p.lon, extract: details.extract, isPriority: isPriority });
                }
            });
            renderList();
            
            // Sau khi scan xong, n·∫øu ƒëang im l·∫∑ng th√¨ k√≠ch ho·∫°t ƒë·ªçc lu√¥n
            if (!synth.speaking && !isPausedByUser) playNextStory();
            
        } catch (e) { console.log("Wiki Error"); }
    }

    function renderList() {
        listEl.innerHTML = "";
        // Render: Nh·ªØng c√°i ƒë√£ ƒë·ªçc xu·ªëng d∆∞·ªõi, ch∆∞a ƒë·ªçc l√™n tr√™n
        // Ch∆∞a ƒë·ªçc sort theo Priority
        let unread = placesQueue.filter(p => !alreadyReadIds.includes(p.id));
        let read = placesQueue.filter(p => alreadyReadIds.includes(p.id));
        
        unread.sort((a,b) => (b.isPriority - a.isPriority));
        
        [...unread, ...read].forEach(p => {
            const li = document.createElement('li');
            const isReadClass = alreadyReadIds.includes(p.id) ? 'read' : '';
            li.className = `place-card ${p.isPriority ? 'priority' : ''} ${isReadClass}`;
            li.id = `place-${p.id}`;
            li.innerHTML = `<div class="place-title">${p.title} <span class="place-badge">Di t√≠ch</span></div><div class="place-desc">${p.extract}</div>`;
            listEl.appendChild(li);
        });
    }

    // SAFETY & UTILS
    let lastOverpassCall = 0;
    let currentLimit = DEFAULT_LIMIT_CAR; 

    function updateSpeedLimitDisplay(limitValue) {
        if (limitValue) currentLimit = limitValue;
        else currentLimit = (vehicleType === 'car') ? DEFAULT_LIMIT_CAR : DEFAULT_LIMIT_BIKE;
        elLimit.innerText = currentLimit;
    }

    async function checkSpeedLimit(speed, lat, lon) {
        if (Date.now() - lastOverpassCall > 15000) {
            lastOverpassCall = Date.now();
            const query = `[out:json];way(around:20,${lat},${lon})["maxspeed"];out tags;`;
            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const d = await res.json();
                if (d.elements && d.elements.length > 0) {
                    let roadLimit = parseInt(d.elements[0].tags.maxspeed);
                    if (!isNaN(roadLimit)) {
                        if (vehicleType === 'bike' && roadLimit > 70) roadLimit = 70;
                        updateSpeedLimitDisplay(roadLimit);
                    } else updateSpeedLimitDisplay(null);
                } else updateSpeedLimitDisplay(null);
            } catch(e) { if(!currentLimit) updateSpeedLimitDisplay(null); }
        }
        
        if (speed > currentLimit + 5) {
            document.getElementById('speed-panel').classList.add('warning');
            if(!synth.speaking) speak("Gi·∫£m t·ªëc ƒë·ªô!", true);
        } else {
            document.getElementById('speed-panel').classList.remove('warning');
        }
    }

    function speak(text, isUrgent) {
        // isUrgent = true (D·∫´n ƒë∆∞·ªùng/C·∫£nh b√°o): Ng·∫Øt l·ªùi -> N√≥i xong KH√îNG t·ª± g·ªçi b√†i ti·∫øp
        // isUrgent = false (Thuy·∫øt minh): N√≥i xong -> T·ª∞ G·ªåI B√ÄI TI·∫æP (Chain Reaction)
        
        if (isUrgent) { 
            synth.cancel(); 
            elStoryPanel.style.display = 'none'; 
        } else { 
            if (synth.speaking || isPausedByUser) return; 
        }
        
        updateAudioButton(true);

        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'vi-VN';
        u.onend = () => { 
            if(!isUrgent) {
                // H·∫øt b√†i thuy·∫øt minh -> ƒê·ªçc b√†i ti·∫øp theo sau 1 gi√¢y
                setTimeout(() => playNextStory(), 1000);
            } else {
                // H·∫øt c√¢u l·ªánh d·∫´n ƒë∆∞·ªùng -> Quay l·∫°i ƒë·ªçc thuy·∫øt minh (n·∫øu ch∆∞a pause)
                if(!isPausedByUser) setTimeout(() => playNextStory(), 500);
            }
        };
        synth.speak(u);
    }
    
    function getDist(lat1,lon1,lat2,lon2) {
        var R=6371000; var dLat=(lat2-lat1)*Math.PI/180; var dLon=(lon2-lon1)*Math.PI/180;
        var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    
    setVehicle('car');
</script>
</body>
</html>
