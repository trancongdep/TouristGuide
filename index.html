
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HDV Du L·ªãch Th√¥ng Minh</title>
    <meta name="theme-color" content="#0d6efd">
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        header {
            background-color: #a73b24;
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 1.1rem; }
        .controls {
            background: white;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-bottom: 1px solid #ddd;
        }
        .btn-group { display: flex; gap: 10px; }
        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
        }
        .btn-scan { background-color: #198754; color: white; }
        .btn-stop { background-color: #dc3545; color: white; flex: 0.4; }
        
        #status {
            text-align: center;
            padding: 10px;
            font-size: 0.85rem;
            color: #666;
            background: #fff3cd;
            margin: 0;
        }
        
        #places-list {
            padding: 15px;
            list-style: none;
            margin: 0;
        }
        
        .place-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid #ddd;
            position: relative;
        }
        /* Style cho ƒë·ªãa ƒëi·ªÉm ph√≠a tr∆∞·ªõc */
        .place-card.ahead {
            border-left: 5px solid #198754; /* M√†u xanh l√° cho h∆∞·ªõng ƒëi t·ªõi */
            background-color: #f0fff4;
        }
        .place-card.active {
            border-left-color: #a73b24;
            background-color: #fff5f5;
        }
        
        .place-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .place-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
            display: block;
        }
        .direction-badge {
            font-size: 0.75rem;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: bold;
            white-space: nowrap;
            margin-left: 8px;
        }
        .badge-ahead { background: #198754; color: white; }
        .badge-history { background: #a73b24; color: white; }
        
        .place-meta {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        .place-desc {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #444;
        }
        
        .speaking-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #dc3545;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1s infinite;
            display: none;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
    </style>
</head>
<body>

<header>
    <h1>HDV Du L·ªãch ·∫¢o <span id="version" style="font-size:0.7em; opacity:0.8">v1.3</span></h1>
</header>

<div class="controls">
    <div id="status">B·∫•m Qu√©t ƒë·ªÉ b·∫Øt ƒë·∫ßu...</div>
    <div class="btn-group">
        <button class="btn-scan" onclick="startTracking()">üöÄ B·∫Øt ƒë·∫ßu ƒëi tour</button>
        <button class="btn-stop" onclick="stopTour()">‚èπ D·ª´ng</button>
    </div>
</div>

<ul id="places-list">
    </ul>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
    authDomain: "tavietnam-78ae8.firebaseapp.com",
    projectId: "tavietnam-78ae8",
    storageBucket: "tavietnam-78ae8.firebasestorage.app",
    messagingSenderId: "670121705534",
    appId: "1:670121705534:web:1027ad98550573ad37116f"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  console.log("Firebase v1.3 initialized");
</script>

<script>
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('places-list');
    let synth = window.speechSynthesis;
    let watchId = null;
    let lastLat = null;
    let lastLon = null;
    let currentHeading = null; // H∆∞·ªõng di chuy·ªÉn (0-360 ƒë·ªô)
    let isSpeaking = false;
    let alreadyReadIds = []; // Danh s√°ch c√°c ID ƒë√£ ƒë·ªçc ƒë·ªÉ tr√°nh ƒë·ªçc l·∫°i li√™n t·ª•c

    // T·ª´ kh√≥a ∆∞u ti√™n
    const PRIORITY_KEYWORDS = [
        'ch√πa', 'ƒë√¨nh', 'ƒë·ªÅn', 'mi·∫øu', 'nh√† th·ªù', 'th√°nh ƒë∆∞·ªùng', 
        'di t√≠ch', 'l·ªãch s·ª≠', 'b·∫£o t√†ng', 'lƒÉng', 't·∫©m', 'th√°p', 
        'c·ªïng', 'ph·ªë c·ªï', 'nh√† h√°t', 'qu·∫£ng tr∆∞·ªùng'
    ];

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }

    function updateStatus(msg) { statusEl.textContent = msg; }

    function stopTour() {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        synth.cancel();
        isSpeaking = false;
        updateStatus("ƒê√£ d·ª´ng. B·∫°n c√≥ th·ªÉ b·∫•m b·∫Øt ƒë·∫ßu l·∫°i.");
    }

    function startTracking() {
        stopTour();
        listEl.innerHTML = '';
        updateStatus("ƒêang ƒë·ªãnh v·ªã v√† x√°c ƒë·ªãnh h∆∞·ªõng ƒëi...");
        alreadyReadIds = [];

        if (!navigator.geolocation) {
            updateStatus("Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ GPS.");
            return;
        }

        // S·ª≠ d·ª•ng watchPosition ƒë·ªÉ c·∫≠p nh·∫≠t li√™n t·ª•c khi di chuy·ªÉn
        watchId = navigator.geolocation.watchPosition(
            handlePositionUpdate,
            (err) => updateStatus("L·ªói GPS: " + err.message),
            { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
        );
    }

    function handlePositionUpdate(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        // L·∫•y h∆∞·ªõng t·ª´ GPS (n·∫øu c√≥) ho·∫∑c t·ª± t√≠nh d·ª±a tr√™n t·ªça ƒë·ªô c≈©
        let heading = position.coords.heading;
        
        if (!heading && lastLat && lastLon) {
            heading = calculateBearing(lastLat, lastLon, lat, lon);
        }

        // C·∫≠p nh·∫≠t v·ªã tr√≠ c≈©
        lastLat = lat;
        lastLon = lon;
        
        // N·∫øu di chuy·ªÉn ƒë·ªß nhanh m·ªõi c√≥ heading ch√≠nh x√°c
        if (heading !== null && !isNaN(heading)) {
            currentHeading = heading;
            updateStatus(`ƒêang di chuy·ªÉn: H∆∞·ªõng ${Math.round(heading)}¬∞`);
        } else {
            updateStatus("ƒêang ƒë·ª©ng y√™n ho·∫∑c ch∆∞a r√µ h∆∞·ªõng. Qu√©t b√°n k√≠nh...");
        }

        // G·ªçi API t√¨m ƒë·ªãa ƒëi·ªÉm
        fetchNearbyPlaces(lat, lon);
    }

    // --- Logic T√≠nh To√°n H∆∞·ªõng (Bearing) ---
    function toRad(deg) { return deg * Math.PI / 180; }
    function toDeg(rad) { return rad * 180 / Math.PI; }

    function calculateBearing(lat1, lon1, lat2, lon2) {
        const dLon = toRad(lon2 - lon1);
        const y = Math.sin(dLon) * Math.cos(toRad(lat2));
        const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                  Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
        const brng = toDeg(Math.atan2(y, x));
        return (brng + 360) % 360; // Chu·∫©n h√≥a v·ªÅ 0-360
    }

    function isAhead(userHeading, targetBearing) {
        if (userHeading === null) return false; // Kh√¥ng bi·∫øt h∆∞·ªõng th√¨ coi nh∆∞ kh√¥ng ph·∫£i ph√≠a tr∆∞·ªõc
        let diff = Math.abs(userHeading - targetBearing);
        if (diff > 180) diff = 360 - diff;
        return diff <= 60; // G√≥c qu√©t 120 ƒë·ªô (60 tr√°i, 60 ph·∫£i) l√† "Ph√≠a tr∆∞·ªõc"
    }

    // --- Logic API & X·ª≠ l√Ω ---

    async function fetchNearbyPlaces(lat, lon) {
        // Qu√©t r·ªông 5km, l·∫•y 30 ƒëi·ªÉm
        const url = `https://vi.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}|${lon}&gsradius=5000&gslimit=30&format=json&origin=*`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (!data.query || !data.query.geosearch) return;

            const places = data.query.geosearch;
            const placeIds = places.map(p => p.pageid).join('|');
            
            fetchDetailsAndSort(placeIds, places, lat, lon);

        } catch (e) { console.error(e); }
    }

    async function fetchDetailsAndSort(ids, originalPlaces, userLat, userLon) {
        const url = `https://vi.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&pageids=${ids}&format=json&origin=*`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            const pages = data.query.pages;

            let processedPlaces = originalPlaces.map(place => {
                const details = pages[place.pageid];
                const bearingToPlace = calculateBearing(userLat, userLon, place.lat, place.lon);
                const ahead = isAhead(currentHeading, bearingToPlace);
                const text = (place.title + " " + (details?.extract || "")).toLowerCase();
                const isHistory = PRIORITY_KEYWORDS.some(k => text.includes(k));

                return {
                    id: place.pageid,
                    title: place.title,
                    dist: place.dist,
                    extract: details ? details.extract : "",
                    bearing: bearingToPlace,
                    isAhead: ahead,
                    isHistory: isHistory,
                    // ƒêi·ªÉm s·ªë ƒë·ªÉ s·∫Øp x·∫øp (C√†ng th·∫•p c√†ng ∆∞u ti√™n)
                    sortScore: calculateSortScore(place.dist, ahead, isHistory)
                };
            });

            // S·∫Øp x·∫øp theo ƒëi·ªÉm s·ªë ∆∞u ti√™n
            processedPlaces.sort((a, b) => a.sortScore - b.sortScore);

            renderPlaces(processedPlaces);
            processSpeechQueue(processedPlaces);

        } catch (e) { console.error(e); }
    }

    function calculateSortScore(dist, isAhead, isHistory) {
        let score = dist; // M·∫∑c ƒë·ªãnh l√† kho·∫£ng c√°ch
        
        // Thu·∫≠t to√°n ∆∞u ti√™n:
        // 1. N·∫øu ƒëang ·ªü ph√≠a tr∆∞·ªõc m·∫∑t (h∆∞·ªõng ƒëi), coi nh∆∞ g·∫ßn h∆°n 60% th·ª±c t·∫ø
        if (isAhead) score *= 0.4; 
        
        // 2. N·∫øu l√† ƒë·ªãa ƒëi·ªÉm l·ªãch s·ª≠, ∆∞u ti√™n ti·∫øp 30%
        if (isHistory) score *= 0.7;

        // V√≠ d·ª•: 
        // - Ch√πa (L·ªãch s·ª≠) ·ªü ph√≠a tr∆∞·ªõc c√°ch 1000m => Score = 1000 * 0.4 * 0.7 = 280 (∆Øu ti√™n nh·∫•t)
        // - Qu√°n cf (Th∆∞·ªùng) ·ªü ph√≠a tr∆∞·ªõc c√°ch 500m => Score = 500 * 0.4 = 200 (V·∫´n ∆∞u ti√™n v√¨ r·∫•t g·∫ßn v√† ti·ªán ƒë∆∞·ªùng)
        // - Ch√πa (L·ªãch s·ª≠) ·ªü sau l∆∞ng c√°ch 300m => Score = 300 * 0.7 = 210
        return score;
    }

    function renderPlaces(places) {
        listEl.innerHTML = '';
        places.forEach(place => {
            let distDisplay = place.dist > 1000 ? (place.dist/1000).toFixed(1)+"km" : Math.round(place.dist)+"m";
            
            // Icon ch·ªâ h∆∞·ªõng
            let directionIcon = "üìç"; // M·∫∑c ƒë·ªãnh
            if (currentHeading !== null) {
                // T√≠nh m≈©i t√™n t∆∞∆°ng ƒë·ªëi
                let relAngle = place.bearing - currentHeading;
                if(place.isAhead) directionIcon = "‚¨ÜÔ∏è Ph√≠a tr∆∞·ªõc";
                else if(relAngle > 45 && relAngle < 135) directionIcon = "‚û°Ô∏è B√™n ph·∫£i";
                else if(relAngle < -45 && relAngle > -135) directionIcon = "‚¨ÖÔ∏è B√™n tr√°i";
                else directionIcon = "‚¨áÔ∏è Ph√≠a sau";
            }

            const li = document.createElement('li');
            li.className = `place-card ${place.isAhead ? 'ahead' : ''}`;
            li.id = `place-${place.id}`;
            
            let badges = "";
            if (place.isAhead) badges += `<span class="direction-badge badge-ahead">Tr√™n ƒë∆∞·ªùng ƒëi</span>`;
            if (place.isHistory) badges += `<span class="direction-badge badge-history">Di t√≠ch</span>`;

            li.innerHTML = `
                <div class="place-header">
                    <span class="place-title">
                        <span class="speaking-indicator"></span>
                        ${place.title}
                    </span>
                </div>
                <div class="place-meta">${directionIcon} ‚Ä¢ C√°ch ${distDisplay} ${badges}</div>
                <div class="place-desc">${truncateText(place.extract, 120)}</div>
            `;
            listEl.appendChild(li);
        });
    }

    function truncateText(text, length) {
        if (!text) return "";
        return text.length > length ? text.substring(0, length) + "..." : text;
    }

    function processSpeechQueue(places) {
        if (synth.speaking) return;

        // T√¨m ƒë·ªãa ƒëi·ªÉm ∆∞u ti√™n nh·∫•t ch∆∞a ƒë·ªçc
        const nextPlace = places.find(p => !alreadyReadIds.includes(p.id) && p.extract.length > 20);

        if (nextPlace) {
            alreadyReadIds.push(nextPlace.id);
            
            let intro = "";
            if (nextPlace.isAhead) intro = "·ªû ph√≠a tr∆∞·ªõc, ";
            else if (nextPlace.isHistory) intro = "G·∫ßn ƒë√¢y c√≥ di t√≠ch, ";
            
            let distText = Math.round(nextPlace.dist) + " m√©t";
            
            const textToRead = `${intro} ${nextPlace.title}. C√°ch b·∫°n ${distText}. ${nextPlace.extract}`;
            speak(textToRead, nextPlace.id);
        }
    }

    function speak(text, placeId) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'vi-VN';
        
        utterance.onstart = () => {
            const card = document.getElementById(`place-${placeId}`);
            if (card) {
                document.querySelectorAll('.place-card').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.speaking-indicator').forEach(el => el.style.display = 'none');
                
                card.classList.add('active');
                card.querySelector('.speaking-indicator').style.display = 'inline-block';
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };

        synth.speak(utterance);
    }
</script>

</body>
</html>
