
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HDV Du L·ªãch & An To√†n 24/7</title>
    <meta name="theme-color" content="#212529">
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; background-color: #f0f2f5; color: #333;
            display: flex; flex-direction: column; height: 100vh;
        }
        
        /* --- DASHBOARD --- */
        #dashboard-container {
            background: #212529; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1001; flex-shrink: 0;
        }

        #speed-panel {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 15px; border-bottom: 1px solid #444; transition: background 0.3s;
        }
        #speed-panel.warning { background: #dc3545; animation: flash 1s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .speed-box { text-align: center; width: 80px; }
        .speed-value { font-size: 1.8rem; font-weight: bold; font-variant-numeric: tabular-nums; line-height: 1; }
        .speed-label { font-size: 0.7rem; text-transform: uppercase; color: #adb5bd; }
        
        /* V√≤ng tr√≤n gi·ªõi h·∫°n t·ªëc ƒë·ªô */
        .limit-circle {
            width: 55px; height: 55px;
            border-radius: 50%; border: 4px solid #dc3545;
            background: white; color: #333;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.4rem;
            position: relative;
        }
        /* Nh√£n nh·ªè "LIMIT" b√™n trong v√≤ng tr√≤n */
        .limit-circle::after {
            content: "LIMIT"; position: absolute; bottom: 4px;
            font-size: 0.5rem; color: #666;
        }

        #nav-panel {
            background: #343a40; padding: 10px 15px; display: none;
            align-items: center; border-bottom: 1px solid #444;
        }
        #nav-icon { font-size: 2rem; margin-right: 15px; min-width: 40px; text-align: center; }
        #nav-text { flex: 1; }
        .nav-instruction { font-size: 1.1rem; font-weight: bold; color: #fff; line-height: 1.2;}
        .nav-distance { font-size: 0.9rem; color: #ffc107; font-weight: bold; }

        #story-panel {
            background: #fff3cd; color: #856404; padding: 10px 15px; font-size: 0.95rem;
            display: none; align-items: center; border-bottom: 1px solid #ffeeba;
        }
        .story-icon { margin-right: 10px; animation: pulse 1s infinite; font-size: 1.2rem;}

        /* --- CONTROLS --- */
        .controls { background: white; padding: 10px; border-bottom: 1px solid #ddd; }
        
        .vehicle-selector {
            display: flex; background: #e9ecef; border-radius: 6px; padding: 3px; margin-bottom: 8px;
        }
        .vehicle-option {
            flex: 1; text-align: center; padding: 6px; cursor: pointer;
            border-radius: 4px; font-weight: 500; font-size: 0.9rem;
        }
        .vehicle-option.active { background: white; color: #0d6efd; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-weight: bold; }

        .input-group { display: flex; gap: 5px; margin-bottom: 8px; }
        input { flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem;}
        
        .action-group { display: flex; gap: 10px; }
        button.action-btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1; font-size: 1rem; color: white;}
        .btn-go { background-color: #198754; }
        .btn-stop { background-color: #6c757d; flex: 0.4; }

        #status { font-size: 0.8rem; color: #666; margin-top: 5px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- MAP & LIST --- */
        #main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #map { height: 50%; width: 100%; background: #e5e3df; }
        #places-list { height: 50%; overflow-y: auto; padding: 0; list-style: none; margin: 0; background: #f8f9fa; }
        
        .place-card { background: white; padding: 12px 15px; border-bottom: 1px solid #dee2e6; border-left: 4px solid transparent; }
        .place-card.priority { border-left-color: #a73b24; background: #fffdfd; }
        .place-card.active { background-color: #ffeeba; border-left-color: #ffc107; }
        .place-title { font-weight: bold; font-size: 1rem; color: #212529; }
        .place-badge { font-size: 0.7rem; background: #a73b24; color: white; padding: 2px 5px; border-radius: 3px; display: none; }
        .place-card.priority .place-badge { display: inline-block; }
        .place-desc { font-size: 0.85rem; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-top: 4px;}
        
    </style>
</head>
<body>

<div id="dashboard-container">
    <div id="speed-panel">
        <div class="speed-box">
            <span class="speed-value" id="current-speed">0</span>
            <span class="speed-label">km/h</span>
        </div>
        
        <div class="limit-circle">
            <span id="speed-limit">50</span>
        </div>

        <div class="speed-box">
            <span class="speed-value" style="font-size: 1.2rem;" id="vehicle-icon">üöó</span>
            <span class="speed-label" id="vehicle-label">√î t√¥</span>
        </div>
    </div>

    <div id="nav-panel">
        <div id="nav-icon">‚¨ÜÔ∏è</div>
        <div id="nav-text">
            <span class="nav-instruction" id="nav-instruction"></span>
            <span class="nav-distance" id="nav-distance"></span>
        </div>
    </div>

    <div id="story-panel">
        <span class="story-icon">üó£Ô∏è</span>
        <span id="story-text">ƒêang thuy·∫øt minh...</span>
    </div>
</div>

<div class="controls">
    <div class="vehicle-selector">
        <div class="vehicle-option active" onclick="setVehicle('car')" id="opt-car">üöó √î t√¥</div>
        <div class="vehicle-option" onclick="setVehicle('bike')" id="opt-bike">üèçÔ∏è Xe m√°y</div>
    </div>

    <div class="input-group">
        <input type="text" id="destination-input" placeholder="ƒê·ªÉ tr·ªëng ƒë·ªÉ ƒëi t·ª± do...">
    </div>
    <div class="action-group">
        <button class="action-btn btn-go" onclick="startApp()">üöÄ B·∫Øt ƒë·∫ßu</button>
        <button class="action-btn btn-stop" onclick="stopApp()">‚èπ D·ª´ng</button>
    </div>
    <div id="status">S·∫µn s√†ng...</div>
</div>

<div id="main-content">
    <div id="map"></div>
    <ul id="places-list"></ul>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  const firebaseConfig = {
    apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
    authDomain: "tavietnam-78ae8.firebaseapp.com",
    projectId: "tavietnam-78ae8",
    storageBucket: "tavietnam-78ae8.firebasestorage.app",
    messagingSenderId: "670121705534",
    appId: "1:670121705534:web:1027ad98550573ad37116f"
  };
  const app = initializeApp(firebaseConfig);
  console.log("App v1.9 Initialized");
</script>

<script>
    // --- KH·ªûI T·∫†O ---
    const map = L.map('map').setView([10.8231, 106.6297], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let userMarker, destMarker, routePolyline;
    let currentLat, currentLon;
    let synth = window.speechSynthesis;
    
    // STATE
    let isRunning = false;
    let isNavigating = false; 
    let vehicleType = 'car';
    
    // NAV & GUIDE DATA
    let routeSteps = [];
    let nextStepIndex = 0;
    let placesQueue = [];
    let alreadyReadIds = [];
    let lastScanLat = 0, lastScanLon = 0;
    
    // UI ELEMENTS
    const elSpeed = document.getElementById('current-speed');
    const elLimit = document.getElementById('speed-limit');
    const elNavPanel = document.getElementById('nav-panel');
    const elStoryPanel = document.getElementById('story-panel');
    const elStoryText = document.getElementById('story-text');
    const listEl = document.getElementById('places-list');

    // T·ªêC ƒê·ªò M·∫∂C ƒê·ªäNH (Khi kh√¥ng c√≥ d·ªØ li·ªáu b·∫£n ƒë·ªì)
    // 50km/h cho √î t√¥ (Quy chu·∫©n ƒë√¥ th·ªã)
    // 40km/h cho Xe m√°y (Quy chu·∫©n ƒë∆∞·ªùng nh·ªè/h·∫ªm an to√†n)
    const DEFAULT_LIMIT_CAR = 50;
    const DEFAULT_LIMIT_BIKE = 40;

    const PRIORITY_KEYWORDS = ['ch√πa', 'ƒë√¨nh', 'ƒë·ªÅn', 'mi·∫øu', 'nh√† th·ªù', 'di t√≠ch', 'l·ªãch s·ª≠', 'b·∫£o t√†ng', 'lƒÉng', 'vƒÉn mi·∫øu', 'qu·ªëc t·ª≠ gi√°m', 'dinh', 'c√¥ng vi√™n'];

    // --- 1. QU·∫¢N L√ù XE & UI ---
    function setVehicle(type) {
        vehicleType = type;
        document.getElementById('opt-car').className = `vehicle-option ${type==='car'?'active':''}`;
        document.getElementById('opt-bike').className = `vehicle-option ${type==='bike'?'active':''}`;
        document.getElementById('vehicle-label').innerText = type==='car'?'√î t√¥':'Xe m√°y';
        document.getElementById('vehicle-icon').innerText = type==='car'?'üöó':'üèçÔ∏è';
        
        // Reset v·ªÅ m·∫∑c ƒë·ªãnh ngay khi ƒë·ªïi xe
        updateSpeedLimitDisplay(null); 
    }
    
    function updateStatus(msg) { document.getElementById('status').innerText = msg; }

    // --- 2. START APP ---
    async function startApp() {
        const destInput = document.getElementById('destination-input').value.trim();
        isRunning = true;
        
        if (destInput) {
            await setupNavigation(destInput);
        } else {
            isNavigating = false;
            elNavPanel.style.display = 'none';
            if (currentLat) {
                map.setView([currentLat, currentLon], 15);
                scanSurroundings(currentLat, currentLon);
            }
            speak("Ch·∫ø ƒë·ªô t·ª± do k√≠ch ho·∫°t. S·∫µn s√†ng thuy·∫øt minh.", true);
        }
    }

    // --- 3. GPS CORE LOOP ---
    function initLocation() {
        if (!navigator.geolocation) return updateStatus("L·ªói: Kh√¥ng c√≥ GPS");
        
        navigator.geolocation.watchPosition(
            (pos) => {
                currentLat = pos.coords.latitude;
                currentLon = pos.coords.longitude;
                // N·∫øu GPS tr·∫£ v·ªÅ null speed (ƒë·ª©ng y√™n), g√°n b·∫±ng 0
                const speedKmh = Math.round((pos.coords.speed || 0) * 3.6);
                
                // Map
                if (!userMarker) {
                    userMarker = L.marker([currentLat, currentLon], {zIndexOffset: 1000}).addTo(map);
                    map.setView([currentLat, currentLon], 15);
                    if(isRunning && !isNavigating && placesQueue.length === 0) scanSurroundings(currentLat, currentLon);
                } else {
                    userMarker.setLatLng([currentLat, currentLon]);
                }
                
                elSpeed.innerText = speedKmh;

                if (isRunning) {
                    // Ki·ªÉm tra t·ªëc ƒë·ªô
                    checkSpeedLimit(speedKmh, currentLat, currentLon);

                    // Nav
                    let navIsBusy = false;
                    if (isNavigating) navIsBusy = processNavigation(currentLat, currentLon);

                    // Guide
                    if (!navIsBusy) processTourGuide(currentLat, currentLon);
                }
            },
            (err) => console.error(err),
            { enableHighAccuracy: true, maximumAge: 1000 }
        );
    }
    initLocation();

    // --- 4. SAFETY MODULE (UPDATE v1.9) ---
    let lastOverpassCall = 0;
    let currentLimit = DEFAULT_LIMIT_CAR; // Kh·ªüi t·∫°o b·∫±ng m·∫∑c ƒë·ªãnh

    // H√†m c·∫≠p nh·∫≠t giao di·ªán limit
    function updateSpeedLimitDisplay(limitValue) {
        if (limitValue) {
            currentLimit = limitValue;
        } else {
            // N·∫øu kh√¥ng c√≥ gi√° tr·ªã (null/undefined), d√πng m·∫∑c ƒë·ªãnh theo lo·∫°i xe
            currentLimit = (vehicleType === 'car') ? DEFAULT_LIMIT_CAR : DEFAULT_LIMIT_BIKE;
        }
        elLimit.innerText = currentLimit;
    }

    async function checkSpeedLimit(speed, lat, lon) {
        // Ch·ªâ g·ªçi API 15s/l·∫ßn
        if (Date.now() - lastOverpassCall > 15000) {
            lastOverpassCall = Date.now();
            
            // Query t√¨m ƒë∆∞·ªùng trong b√°n k√≠nh 20m
            const query = `[out:json];way(around:20,${lat},${lon})["maxspeed"];out tags;`;
            
            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const d = await res.json();
                
                if (d.elements && d.elements.length > 0) {
                    let roadLimit = parseInt(d.elements[0].tags.maxspeed);
                    
                    if (!isNaN(roadLimit)) {
                        // Logic gi·ªõi h·∫°n xe m√°y
                        if (vehicleType === 'bike' && roadLimit > 70) roadLimit = 70;
                        updateSpeedLimitDisplay(roadLimit);
                    } else {
                        // T√¨m th·∫•y ƒë∆∞·ªùng nh∆∞ng kh√¥ng c√≥ tag maxspeed -> D√πng m·∫∑c ƒë·ªãnh
                        updateSpeedLimitDisplay(null);
                    }
                } else {
                    // Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng (Off-road) -> D√πng m·∫∑c ƒë·ªãnh
                    updateSpeedLimitDisplay(null);
                }
            } catch(e) {
                // L·ªói m·∫°ng -> Gi·ªØ nguy√™n gi√° tr·ªã c≈© ho·∫∑c d√πng m·∫∑c ƒë·ªãnh
                if(!currentLimit) updateSpeedLimitDisplay(null);
            }
        }
        
        // Ki·ªÉm tra qu√° t·ªëc ƒë·ªô
        if (speed > currentLimit + 5) { // Cho ph√©p sai s·ªë 5km/h
            document.getElementById('speed-panel').classList.add('warning');
            if(!synth.speaking) speak("Qu√° t·ªëc ƒë·ªô! Gi·∫£m ga ngay.", true);
        } else {
            document.getElementById('speed-panel').classList.remove('warning');
        }
    }

    // --- 5. NAVIGATION MODULE ---
    async function setupNavigation(query) {
        updateStatus("ƒêang t√≠nh to√°n...");
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=vn&limit=1`);
        const data = await res.json();
        if (data.length === 0) return alert("Kh√¥ng t√¨m th·∫•y!");
        
        const dest = data[0];
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker([dest.lat, dest.lon]).addTo(map).bindPopup("ƒê√≠ch").openPopup();

        const url = `https://router.project-osrm.org/route/v1/driving/${currentLon},${currentLat};${dest.lon},${dest.lat}?overview=full&geometries=geojson&steps=true`;
        const routeRes = await fetch(url);
        const routeData = await routeRes.json();
        
        if (routeData.code !== 'Ok') return alert("L·ªói ƒë∆∞·ªùng ƒëi!");

        const route = routeData.routes[0];
        routeSteps = route.legs[0].steps;
        nextStepIndex = 1;
        isNavigating = true;
        elNavPanel.style.display = 'flex';

        const latLngs = route.geometry.coordinates.map(c => [c[1], c[0]]);
        if (routePolyline) map.removeLayer(routePolyline);
        routePolyline = L.polyline(latLngs, {color: '#0d6efd', weight: 6}).addTo(map);
        map.fitBounds(routePolyline.getBounds());

        speak(`B·∫Øt ƒë·∫ßu ƒëi ƒë·∫øn ${dest.display_name.split(',')[0]}.`, true);
    }

    function processNavigation(lat, lon) {
        if (!routeSteps || nextStepIndex >= routeSteps.length) return false;
        const nextStep = routeSteps[nextStepIndex];
        const stepLoc = nextStep.maneuver.location;
        const dist = getDist(lat, lon, stepLoc[1], stepLoc[0]);

        document.getElementById('nav-distance').innerText = dist < 1000 ? Math.round(dist)+"m" : (dist/1000).toFixed(1)+"km";
        
        let instruction = "ƒêi th·∫≥ng";
        let icon = "‚¨ÜÔ∏è";
        const modifier = nextStep.maneuver.modifier;
        
        if (nextStep.maneuver.type === 'turn') {
            if (modifier && modifier.includes('right')) { icon = "‚û°Ô∏è"; instruction = "R·∫Ω ph·∫£i"; }
            if (modifier && modifier.includes('left')) { icon = "‚¨ÖÔ∏è"; instruction = "R·∫Ω tr√°i"; }
        } else if (nextStep.maneuver.type === 'arrive') {
             icon = "üèÅ"; instruction = "ƒê·∫øn ƒë√≠ch";
        }

        document.getElementById('nav-instruction').innerText = instruction;
        document.getElementById('nav-icon').innerText = icon;

        if (dist < 30) { nextStepIndex++; return true; }
        if (dist < 150 && dist > 120 && !synth.speaking) { speak(`S·∫Øp ${instruction}.`, true); return true; }
        return false;
    }

    // --- 6. TOUR GUIDE MODULE ---
    function processTourGuide(lat, lon) {
        if (getDist(lat, lon, lastScanLat, lastScanLon) > 2000) scanSurroundings(lat, lon);
        if (synth.speaking) return;

        let nearest = null;
        let minDist = 99999;
        placesQueue.forEach(p => {
            if (alreadyReadIds.includes(p.id)) return;
            const d = getDist(lat, lon, p.lat, p.lon);
            if (d < 500) { if (d < minDist) { minDist = d; nearest = p; } }
        });

        if (nearest) {
            alreadyReadIds.push(nearest.id);
            // Highlight
            document.querySelectorAll('.place-card').forEach(e => e.classList.remove('active'));
            const card = document.getElementById(`place-${nearest.id}`);
            if(card) { card.classList.add('active'); card.scrollIntoView({behavior:"smooth", block:"center"}); }

            elStoryPanel.style.display = 'flex';
            elStoryText.innerText = nearest.title;
            speak(`${nearest.isPriority ? 'Ch√∫ √Ω di t√≠ch. ' : 'T·∫°i ƒë√¢y c√≥ '} ${nearest.title}. ${nearest.extract}`, false);
        } else {
             if(!synth.speaking) elStoryPanel.style.display = 'none';
        }
    }

    async function scanSurroundings(lat, lon) {
        lastScanLat = lat; lastScanLon = lon;
        updateStatus("ƒêang t√¨m ƒë·ªãa ƒëi·ªÉm...");
        const url = `https://vi.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}|${lon}&gsradius=2000&gslimit=15&format=json&origin=*`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (!data.query || !data.query.geosearch) return;
        const newPlaces = data.query.geosearch.filter(p => !placesQueue.some(old => old.id === p.pageid));
        if (newPlaces.length === 0) return;

        const ids = newPlaces.map(p => p.pageid).join('|');
        const detailRes = await fetch(`https://vi.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&pageids=${ids}&format=json&origin=*`);
        const detailData = await detailRes.json();
        const pages = detailData.query.pages;

        newPlaces.forEach(p => {
            const details = pages[p.pageid];
            if (details && details.extract && details.extract.length > 30) {
                const text = (p.title + " " + details.extract).toLowerCase();
                const isPriority = PRIORITY_KEYWORDS.some(k => text.includes(k));
                placesQueue.push({ id: p.pageid, title: p.title, lat: p.lat, lon: p.lon, extract: details.extract, isPriority: isPriority });
            }
        });
        renderList();
    }

    function renderList() {
        listEl.innerHTML = "";
        placesQueue.sort((a,b) => (b.isPriority - a.isPriority));
        placesQueue.forEach(p => {
            if (alreadyReadIds.includes(p.id)) return;
            const li = document.createElement('li');
            li.className = `place-card ${p.isPriority ? 'priority' : ''}`;
            li.id = `place-${p.id}`;
            li.innerHTML = `<div class="place-title">${p.title} <span class="place-badge">Di t√≠ch</span></div><div class="place-desc">${p.extract}</div>`;
            listEl.appendChild(li);
        });
    }

    // --- UTILS ---
    function speak(text, isUrgent) {
        if (isUrgent) { synth.cancel(); elStoryPanel.style.display = 'none'; }
        else { if (synth.speaking) return; }
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'vi-VN';
        u.onend = () => { if(!isUrgent) elStoryPanel.style.display = 'none'; };
        synth.speak(u);
    }
    function getDist(lat1,lon1,lat2,lon2) {
        var R=6371000; var dLat=(lat2-lat1)*Math.PI/180; var dLon=(lon2-lon1)*Math.PI/180;
        var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    function stopApp() {
        isRunning = false; isNavigating = false; synth.cancel();
        elNavPanel.style.display = 'none'; elStoryPanel.style.display = 'none';
        updateStatus("ƒê√£ d·ª´ng.");
    }
    
    // Kh·ªüi t·∫°o m·∫∑c ƒë·ªãnh
    setVehicle('car');
</script>
</body>
</html>
