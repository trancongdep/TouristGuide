
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>D·∫´n ƒê∆∞·ªùng & C·∫£nh B√°o Giao Th√¥ng</title>
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* --- DASHBOARD T·ªêC ƒê·ªò & CH·ªà D·∫™N --- */
        #dashboard-container {
            background: #212529;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1001;
            flex-shrink: 0;
        }

        /* Ph·∫ßn tr√™n: T·ªëc ƒë·ªô */
        #speed-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #444;
            transition: background 0.3s;
        }
        #speed-panel.warning {
            background: #dc3545;
            animation: flash 1s infinite;
        }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .speed-box { text-align: center; }
        .speed-value { font-size: 2.2rem; font-weight: bold; font-variant-numeric: tabular-nums; line-height: 1; }
        .speed-label { font-size: 0.7rem; text-transform: uppercase; color: #adb5bd; }
        
        .limit-circle {
            width: 55px; height: 55px;
            border-radius: 50%;
            border: 4px solid #dc3545;
            background: white; color: #333;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.4rem;
        }

        /* Ph·∫ßn d∆∞·ªõi: Ch·ªâ d·∫´n ƒë∆∞·ªùng ƒëi */
        #nav-panel {
            background: #343a40;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            min-height: 60px;
        }
        #nav-icon {
            font-size: 2rem;
            margin-right: 15px;
            width: 40px; text-align: center;
        }
        #nav-text {
            flex: 1;
        }
        .nav-instruction { font-size: 1.1rem; font-weight: bold; color: #fff; display: block;}
        .nav-distance { font-size: 0.9rem; color: #ffc107; font-weight: bold; }
        .lane-hint { display: block; font-size: 0.85rem; color: #66d9e8; margin-top: 2px; font-style: italic;}

        /* --- CONTROLS --- */
        .controls {
            background: white;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        /* Ch·ªçn lo·∫°i xe */
        .vehicle-selector {
            display: flex;
            background: #e9ecef;
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 10px;
        }
        .vehicle-option {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .vehicle-option.active {
            background: white;
            color: #0d6efd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-weight: bold;
        }

        .input-group { display: flex; gap: 5px; margin-bottom: 8px; }
        input { flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem;}
        .btn-search { background: #0d6efd; color: white; border: none; padding: 0 15px; border-radius: 6px; font-size: 1.2rem; }
        
        .action-group { display: flex; gap: 10px; }
        button.action-btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1; font-size: 1rem;}
        .btn-go { background-color: #198754; color: white; }
        .btn-stop { background-color: #6c757d; color: white; flex: 0.4; }

        #status { font-size: 0.8rem; color: #666; margin-top: 5px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- MAP & LIST --- */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        #map { height: 60%; width: 100%; background: #e5e3df; }
        #places-list {
            height: 40%;
            overflow-y: auto;
            padding: 0;
            list-style: none;
            margin: 0;
            background: #f8f9fa;
        }
        
        .place-card {
            background: white;
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .place-card.active { background-color: #e7f1ff; border-left: 4px solid #0d6efd; }
        .place-info h4 { margin: 0 0 4px 0; font-size: 1rem; color: #495057; }
        .place-info p { margin: 0; font-size: 0.8rem; color: #868e96; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        
    </style>
</head>
<body>

<div id="dashboard-container">
    <div id="speed-panel">
        <div class="speed-box">
            <span class="speed-value" id="current-speed">0</span>
            <span class="speed-label">km/h</span>
        </div>
        
        <div class="limit-circle">
            <span id="speed-limit">--</span>
        </div>

        <div class="speed-box">
            <span class="speed-value" style="font-size: 1.2rem; color: #ffc107" id="vehicle-icon">üöó</span>
            <span class="speed-label" id="vehicle-label">√î t√¥</span>
        </div>
    </div>

    <div id="nav-panel" style="display:none;">
        <div id="nav-icon">‚¨ÜÔ∏è</div>
        <div id="nav-text">
            <span class="nav-instruction" id="nav-instruction">ƒêi th·∫≥ng</span>
            <span class="nav-distance" id="nav-distance">-- m</span>
            <span class="lane-hint" id="lane-hint"></span>
        </div>
    </div>
</div>

<div class="controls">
    <div class="vehicle-selector">
        <div class="vehicle-option active" onclick="setVehicle('car')" id="opt-car">üöó √î t√¥</div>
        <div class="vehicle-option" onclick="setVehicle('bike')" id="opt-bike">üèçÔ∏è Xe m√°y</div>
    </div>

    <div class="input-group">
        <input type="text" id="destination-input" placeholder="ƒêi·ªÉm ƒë·∫øn (VD: Ch·ª£ B·∫øn Th√†nh)">
        <button class="btn-search" onclick="searchDestination()">üîç</button>
    </div>
    <div class="action-group">
        <button class="action-btn btn-go" onclick="calculateRouteAndScan()">üöÄ B·∫Øt ƒë·∫ßu ƒëi</button>
        <button class="action-btn btn-stop" onclick="stopTour()">‚èπ D·ª´ng</button>
    </div>
    <div id="status">Ch·ªçn ph∆∞∆°ng ti·ªán v√† ƒëi·ªÉm ƒë·∫øn...</div>
</div>

<div id="main-content">
    <div id="map"></div>
    <ul id="places-list"></ul>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  const firebaseConfig = {
    apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
    authDomain: "tavietnam-78ae8.firebaseapp.com",
    projectId: "tavietnam-78ae8",
    storageBucket: "tavietnam-78ae8.firebasestorage.app",
    messagingSenderId: "670121705534",
    appId: "1:670121705534:web:1027ad98550573ad37116f"
  };
  const app = initializeApp(firebaseConfig);
  console.log("App v1.6 Initialized");
</script>

<script>
    // --- KH·ªûI T·∫†O ---
    const map = L.map('map').setView([10.8231, 106.6297], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // --- VARIABLES ---
    let userMarker, destMarker, routePolyline;
    let currentLat, currentLon;
    let currentHeading = 0;
    let synth = window.speechSynthesis;
    let isTourActive = false;
    let vehicleType = 'car'; // 'car' or 'bike'
    
    let routeSteps = []; // C√°c b∆∞·ªõc d·∫´n ƒë∆∞·ªùng
    let nextStepIndex = 0;
    let currentSpeedLimit = null;
    let lastOverpassCall = 0;
    
    // DOM Elements
    const elSpeed = document.getElementById('current-speed');
    const elLimit = document.getElementById('speed-limit');
    const elSpeedPanel = document.getElementById('speed-panel');
    const elNavPanel = document.getElementById('nav-panel');
    const elNavIcon = document.getElementById('nav-icon');
    const elNavInstr = document.getElementById('nav-instruction');
    const elNavDist = document.getElementById('nav-distance');
    const elLaneHint = document.getElementById('lane-hint');

    // --- 1. QU·∫¢N L√ù LO·∫†I XE ---
    function setVehicle(type) {
        vehicleType = type;
        document.getElementById('opt-car').className = `vehicle-option ${type === 'car' ? 'active' : ''}`;
        document.getElementById('opt-bike').className = `vehicle-option ${type === 'bike' ? 'active' : ''}`;
        
        const label = type === 'car' ? '√î t√¥' : 'Xe m√°y';
        const icon = type === 'car' ? 'üöó' : 'üèçÔ∏è';
        document.getElementById('vehicle-label').innerText = label;
        document.getElementById('vehicle-icon').innerText = icon;
        
        // Reset limit display
        elLimit.innerText = "--";
        currentSpeedLimit = null;
    }

    // --- 2. GPS & T·ªêC ƒê·ªò ---
    function initLocation() {
        if (!navigator.geolocation) return updateStatus("Kh√¥ng h·ªó tr·ª£ GPS");
        
        navigator.geolocation.watchPosition(
            (pos) => {
                currentLat = pos.coords.latitude;
                currentLon = pos.coords.longitude;
                const speedMps = pos.coords.speed || 0;
                const speedKmh = Math.round(speedMps * 3.6);
                
                // C·∫≠p nh·∫≠t Marker
                if (!userMarker) {
                    userMarker = L.marker([currentLat, currentLon], {zIndexOffset: 1000}).addTo(map);
                    map.setView([currentLat, currentLon], 16);
                } else {
                    userMarker.setLatLng([currentLat, currentLon]);
                }

                elSpeed.innerText = speedKmh;

                if (isTourActive) {
                    checkSpeedLimit(speedKmh, currentLat, currentLon);
                    updateNavigation(currentLat, currentLon);
                }
            },
            (err) => console.error(err),
            { enableHighAccuracy: true, maximumAge: 1000 }
        );
    }
    initLocation();

    // --- 3. KI·ªÇM TRA T·ªêC ƒê·ªò (LU·∫¨T XE M√ÅY/√î T√î) ---
    async function checkSpeedLimit(currentSpeed, lat, lon) {
        // G·ªçi API Overpass m·ªói 15s
        const now = Date.now();
        if (now - lastOverpassCall > 15000) {
            lastOverpassCall = now;
            // Query t√¨m maxspeed
            const query = `[out:json];way(around:25, ${lat}, ${lon})["maxspeed"];out tags;`;
            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await res.json();
                
                if (data.elements && data.elements.length > 0) {
                    let rawLimit = parseInt(data.elements[0].tags.maxspeed);
                    
                    if (!isNaN(rawLimit)) {
                        // LOGIC QUAN TR·ªåNG: ƒêi·ªÅu ch·ªânh theo lo·∫°i xe
                        if (vehicleType === 'bike') {
                            // Xe m√°y ·ªü VN: ƒê∆∞·ªùng ƒë√¥i c√≥ d·∫£i ph√¢n c√°ch th∆∞·ªùng max 60, kh√¥ng c√≥ th√¨ 50
                            // Ngo√†i khu d√¢n c∆∞: Max 70 (ƒë∆∞·ªùng ƒë√¥i), 60 (kh√¥ng)
                            // ƒê√¢y l√† logic ƒë∆°n gi·∫£n h√≥a an to√†n cho xe m√°y:
                            // N·∫øu bi·ªÉn b√°o > 70km/h (t·ª©c l√† ƒë∆∞·ªùng qu·ªëc l·ªô/cao t·ªëc), xe m√°y th∆∞·ªùng b·ªã gi·ªõi h·∫°n 60-70.
                            // Cap c·ª©ng ·ªü 70km/h cho xe m√°y ƒë·ªÉ an to√†n.
                            if (rawLimit > 70) {
                                currentSpeedLimit = 70; 
                            } else {
                                currentSpeedLimit = rawLimit;
                            }
                        } else {
                            // √î t√¥: Theo bi·ªÉn b√°o
                            currentSpeedLimit = rawLimit;
                        }
                        elLimit.innerText = currentSpeedLimit;
                    } else {
                        currentSpeedLimit = null;
                        elLimit.innerText = "--";
                    }
                }
            } catch (e) { console.error(e); }
        }

        // C·∫£nh b√°o
        if (currentSpeedLimit && currentSpeed > currentSpeedLimit + 5) {
            elSpeedPanel.classList.add('warning');
            // Ph√°t √¢m thanh c·∫£nh b√°o ng·∫Øn n·∫øu ch∆∞a n√≥i
            if (!synth.speaking) speak("B·∫°n ƒëang ch·∫°y qu√° t·ªëc ƒë·ªô.");
        } else {
            elSpeedPanel.classList.remove('warning');
        }
    }

    // --- 4. T√åM ƒê∆Ø·ªúNG & NAVIGATE (OSRM) ---
    async function searchDestination() {
        const query = document.getElementById('destination-input').value;
        if (!query) return alert("Nh·∫≠p ƒëi·ªÉm ƒë·∫øn!");
        
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=vn&limit=1`);
        const data = await res.json();
        
        if (data.length === 0) return updateStatus("Kh√¥ng t√¨m th·∫•y.");
        const dest = data[0];
        
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker([dest.lat, dest.lon]).addTo(map).bindPopup("ƒê√≠ch").openPopup();
        map.fitBounds(L.featureGroup([userMarker, destMarker]).getBounds().pad(0.2));
    }

    async function calculateRouteAndScan() {
        if (!destMarker) return alert("Ch·ªçn ƒëi·ªÉm ƒë·∫øn tr∆∞·ªõc.");
        
        isTourActive = true;
        elNavPanel.style.display = 'flex';
        updateStatus("ƒêang t√≠nh to√°n...");
        
        const destPos = destMarker.getLatLng();
        // steps=true ƒë·ªÉ l·∫•y h∆∞·ªõng d·∫´n r·∫Ω
        const url = `https://router.project-osrm.org/route/v1/driving/${currentLon},${currentLat};${destPos.lng},${destPos.lat}?overview=full&geometries=geojson&steps=true`;
        
        try {
            const res = await fetch(url);
            const data = await res.json();
            if (data.code !== 'Ok') return updateStatus("L·ªói routing.");
            
            const route = data.routes[0];
            routeSteps = route.legs[0].steps; // L∆∞u c√°c b∆∞·ªõc di chuy·ªÉn
            nextStepIndex = 1; // B·∫Øt ƒë·∫ßu theo d√µi b∆∞·ªõc ti·∫øp theo
            
            // V·∫Ω ƒë∆∞·ªùng
            const latLngs = route.geometry.coordinates.map(c => [c[1], c[0]]);
            if (routePolyline) map.removeLayer(routePolyline);
            routePolyline = L.polyline(latLngs, {color: '#0d6efd', weight: 6}).addTo(map);
            map.fitBounds(routePolyline.getBounds());
            
            // Qu√©t di t√≠ch (Logic c≈©)
            scanPlaces(latLngs);
            speak(`B·∫Øt ƒë·∫ßu di chuy·ªÉn b·∫±ng ${vehicleType === 'car' ? '√¥ t√¥' : 'xe m√°y'}.`, null);

        } catch (e) { updateStatus("L·ªói k·∫øt n·ªëi."); }
    }

    // --- 5. LOGIC D·∫™N ƒê∆Ø·ªúNG & CH·ªåN L√ÄN ---
    function updateNavigation(lat, lon) {
        if (!routeSteps || nextStepIndex >= routeSteps.length) {
            elNavInstr.innerText = "ƒê√£ ƒë·∫øn n∆°i";
            elNavDist.innerText = "";
            return;
        }

        const nextStep = routeSteps[nextStepIndex];
        const stepLoc = nextStep.maneuver.location; // [lon, lat]
        const distToStep = getDist(lat, lon, stepLoc[1], stepLoc[0]);

        // C·∫≠p nh·∫≠t kho·∫£ng c√°ch hi·ªÉn th·ªã
        elNavDist.innerText = distToStep < 1000 ? Math.round(distToStep) + " m" : (distToStep/1000).toFixed(1) + " km";

        // Logic chuy·ªÉn b∆∞·ªõc: N·∫øu ƒë√£ ƒëi qua ƒëi·ªÉm r·∫Ω (c√≤n < 30m)
        if (distToStep < 30) {
            nextStepIndex++;
            updateNavigation(lat, lon); // G·ªçi l·∫°i ngay
            return;
        }

        // --- X·ª¨ L√ù H∆Ø·ªöNG D·∫™N & L√ÄN ƒê∆Ø·ªúNG ---
        const modifier = nextStep.maneuver.modifier; // right, left, slight right...
        const type = nextStep.maneuver.type; // turn, new name, roundabout...
        
        let icon = "‚¨ÜÔ∏è";
        let instruction = "ƒêi th·∫≥ng";
        let laneMsg = "";

        // D·ªãch v√† t·∫°o ch·ªâ d·∫´n l√†n
        if (type === 'turn' || type === 'roundabout') {
            if (modifier && modifier.includes('right')) {
                icon = "‚û°Ô∏è";
                instruction = "R·∫Ω ph·∫£i";
                // CH·ªà D·∫™N L√ÄN
                if (distToStep < 300) { // Ch·ªâ nh·∫Øc khi c√≤n 300m
                    laneMsg = "üí° ƒêi l√†n b√™n ph·∫£i ƒë·ªÉ r·∫Ω";
                    if (!synth.speaking && distToStep < 150 && distToStep > 100) {
                        speak("S·∫Øp r·∫Ω ph·∫£i, vui l√≤ng ƒëi v√†o l√†n ph·∫£i.");
                    }
                }
            } else if (modifier && modifier.includes('left')) {
                icon = "‚¨ÖÔ∏è";
                instruction = "R·∫Ω tr√°i";
                if (distToStep < 300) {
                    laneMsg = "üí° Chuy·ªÉn sang l√†n tr√°i";
                    if (!synth.speaking && distToStep < 150 && distToStep > 100) {
                         speak("S·∫Øp r·∫Ω tr√°i, ch√∫ √Ω chuy·ªÉn l√†n.");
                    }
                }
            }
        } else if (type === 'arrive') {
            icon = "üèÅ";
            instruction = "S·∫Øp ƒë·∫øn ƒë√≠ch";
        }

        elNavIcon.innerText = icon;
        elNavInstr.innerText = instruction + (nextStep.name ? " v√†o " + nextStep.name : "");
        elLaneHint.innerText = laneMsg;
    }

    // --- 6. QU√âT DI T√çCH (Gi·∫£n l∆∞·ª£c cho g·ªçn) ---
    async function scanPlaces(pathCoords) {
        // L·∫•y m·∫´u ƒëi·ªÉm ƒë·ªÉ qu√©t nh∆∞ v1.5
        const step = Math.floor(pathCoords.length / 10) || 1;
        const points = [];
        for(let i=0; i<pathCoords.length; i+=step) points.push(pathCoords[i]);
        
        // Demo: T√¨m t∆∞·ª£ng tr∆∞ng 1 ƒëi·ªÉm xung quanh ƒë√≠ch
        // (Trong th·ª±c t·∫ø code n√†y s·∫Ω g·ªçi API Wiki nh∆∞ v1.5)
        const dest = pathCoords[pathCoords.length-1];
        fetchWikiPlaces(dest[0], dest[1]);
    }

    async function fetchWikiPlaces(lat, lon) {
        const url = `https://vi.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}|${lon}&gsradius=2000&gslimit=5&format=json&origin=*`;
        const res = await fetch(url);
        const data = await res.json();
        const list = document.getElementById('places-list');
        list.innerHTML = "";
        
        if (data.query && data.query.geosearch) {
            data.query.geosearch.forEach(p => {
                list.innerHTML += `<li class="place-card">
                    <div class="place-info"><h4>${p.title}</h4><p>C√°ch ƒë√≠ch ${(p.dist/1000).toFixed(1)}km</p></div>
                    <button onclick="speak('${p.title}', null)" style="padding:5px">üîä</button>
                </li>`;
            });
        }
    }

    // --- TI·ªÜN √çCH ---
    function updateStatus(msg) { document.getElementById('status').innerText = msg; }
    function stopTour() { isTourActive = false; synth.cancel(); elNavPanel.style.display = 'none'; updateStatus("ƒê√£ d·ª´ng."); }
    function speak(txt) { const u = new SpeechSynthesisUtterance(txt); u.lang = 'vi-VN'; synth.speak(u); }
    function getDist(lat1,lon1,lat2,lon2) {
        var R=6371000; var dLat=(lat2-lat1)*Math.PI/180; var dLon=(lon2-lon1)*Math.PI/180;
        var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
</script>

</body>
</html>
