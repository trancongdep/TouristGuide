
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HDV Du L·ªãch & D·∫´n ƒê∆∞·ªùng</title>
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* --- DASHBOARD --- */
        #dashboard-container {
            background: #212529;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1001;
            flex-shrink: 0;
        }

        /* Panel T·ªëc ƒë·ªô & Lo·∫°i xe */
        #speed-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            border-bottom: 1px solid #444;
            transition: background 0.3s;
        }
        #speed-panel.warning {
            background: #dc3545;
            animation: flash 1s infinite;
        }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .speed-box { text-align: center; }
        .speed-value { font-size: 1.8rem; font-weight: bold; font-variant-numeric: tabular-nums; line-height: 1; }
        .speed-label { font-size: 0.7rem; text-transform: uppercase; color: #adb5bd; }
        
        .limit-circle {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: 3px solid #dc3545;
            background: white; color: #333;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.2rem;
        }

        /* Panel D·∫´n ƒë∆∞·ªùng */
        #nav-panel {
            background: #343a40;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            min-height: 60px;
            border-bottom: 1px solid #444;
        }
        #nav-icon { font-size: 2rem; margin-right: 15px; min-width: 40px; text-align: center; }
        #nav-text { flex: 1; }
        .nav-instruction { font-size: 1.1rem; font-weight: bold; color: #fff; display: block; line-height: 1.2;}
        .nav-distance { font-size: 0.9rem; color: #ffc107; font-weight: bold; }
        .lane-hint { display: block; font-size: 0.85rem; color: #66d9e8; margin-top: 2px; font-style: italic;}

        /* Panel Thuy·∫øt minh ƒëang ƒë·ªçc (M·ªõi v1.7) */
        #story-panel {
            background: #fff3cd;
            color: #856404;
            padding: 8px 15px;
            font-size: 0.9rem;
            display: none; /* Ch·ªâ hi·ªán khi ƒëang ƒë·ªçc */
            align-items: center;
            border-bottom: 1px solid #ffeeba;
        }
        .story-icon { margin-right: 10px; animation: pulse 1s infinite; }

        /* --- CONTROLS --- */
        .controls {
            background: white;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .vehicle-selector {
            display: flex;
            background: #e9ecef;
            border-radius: 6px;
            padding: 3px;
            margin-bottom: 8px;
        }
        .vehicle-option {
            flex: 1;
            text-align: center;
            padding: 6px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .vehicle-option.active {
            background: white;
            color: #0d6efd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-weight: bold;
        }

        .input-group { display: flex; gap: 5px; margin-bottom: 8px; }
        input { flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem;}
        .btn-search { background: #0d6efd; color: white; border: none; padding: 0 15px; border-radius: 6px; font-size: 1.2rem; }
        
        .action-group { display: flex; gap: 10px; }
        button.action-btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1; font-size: 1rem;}
        .btn-go { background-color: #198754; color: white; }
        .btn-stop { background-color: #6c757d; color: white; flex: 0.4; }

        #status { font-size: 0.8rem; color: #666; margin-top: 5px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- MAP & LIST --- */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        #map { height: 50%; width: 100%; background: #e5e3df; }
        #places-list {
            height: 50%;
            overflow-y: auto;
            padding: 0;
            list-style: none;
            margin: 0;
            background: #f8f9fa;
        }
        
        .place-card {
            background: white;
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            border-left: 4px solid transparent;
        }
        .place-card.priority { border-left-color: #a73b24; background: #fffdfd; }
        .place-card.active { background-color: #ffeeba; border-left-color: #ffc107; }
        
        .place-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .place-title { font-weight: bold; font-size: 1rem; color: #212529; }
        .place-badge { font-size: 0.7rem; background: #a73b24; color: white; padding: 2px 5px; border-radius: 3px; display: none; }
        .place-card.priority .place-badge { display: inline-block; }
        
        .place-desc { font-size: 0.85rem; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
        
    </style>
</head>
<body>

<div id="dashboard-container">
    <div id="speed-panel">
        <div class="speed-box">
            <span class="speed-value" id="current-speed">0</span>
            <span class="speed-label">km/h</span>
        </div>
        
        <div class="limit-circle">
            <span id="speed-limit">--</span>
        </div>

        <div class="speed-box">
            <span class="speed-value" style="font-size: 1.2rem;" id="vehicle-icon">üöó</span>
            <span class="speed-label" id="vehicle-label">√î t√¥</span>
        </div>
    </div>

    <div id="nav-panel" style="display:none;">
        <div id="nav-icon">‚¨ÜÔ∏è</div>
        <div id="nav-text">
            <span class="nav-instruction" id="nav-instruction">S·∫µn s√†ng</span>
            <span class="nav-distance" id="nav-distance">-- m</span>
            <span class="lane-hint" id="lane-hint"></span>
        </div>
    </div>

    <div id="story-panel">
        <span class="story-icon">üîä</span>
        <span id="story-text">ƒêang thuy·∫øt minh v·ªÅ...</span>
    </div>
</div>

<div class="controls">
    <div class="vehicle-selector">
        <div class="vehicle-option active" onclick="setVehicle('car')" id="opt-car">üöó √î t√¥</div>
        <div class="vehicle-option" onclick="setVehicle('bike')" id="opt-bike">üèçÔ∏è Xe m√°y</div>
    </div>

    <div class="input-group">
        <input type="text" id="destination-input" placeholder="Nh·∫≠p ƒëi·ªÉm ƒë·∫øn (VD: VƒÉn Mi·∫øu)">
        <button class="btn-search" onclick="searchDestination()">üîç</button>
    </div>
    <div class="action-group">
        <button class="action-btn btn-go" onclick="calculateRouteAndScan()">üèõ D·∫´n ƒë∆∞·ªùng & HDV</button>
        <button class="action-btn btn-stop" onclick="stopTour()">‚èπ D·ª´ng</button>
    </div>
    <div id="status">S·∫µn s√†ng kh·ªüi h√†nh...</div>
</div>

<div id="main-content">
    <div id="map"></div>
    <ul id="places-list">
        </ul>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  const firebaseConfig = {
    apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
    authDomain: "tavietnam-78ae8.firebaseapp.com",
    projectId: "tavietnam-78ae8",
    storageBucket: "tavietnam-78ae8.firebasestorage.app",
    messagingSenderId: "670121705534",
    appId: "1:670121705534:web:1027ad98550573ad37116f"
  };
  const app = initializeApp(firebaseConfig);
  console.log("Firebase v1.7 Initialized");
</script>

<script>
    // --- VARIABLES & SETUP ---
    const map = L.map('map').setView([10.8231, 106.6297], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let userMarker, destMarker, routePolyline;
    let currentLat, currentLon, currentHeading;
    let synth = window.speechSynthesis;
    
    // State Variables
    let isTourActive = false;
    let vehicleType = 'car';
    let routeSteps = [];
    let nextStepIndex = 0;
    let currentSpeedLimit = null;
    let lastOverpassCall = 0;
    
    // Tour Guide Data
    let placesQueue = [];     // Danh s√°ch ƒë·ªãa ƒëi·ªÉm ƒë√£ t√¨m th·∫•y
    let alreadyReadIds = [];  // ID c√°c ƒë·ªãa ƒëi·ªÉm ƒë√£ ƒë·ªçc ƒë·ªÉ kh√¥ng l·∫∑p l·∫°i
    
    // Priority Keywords for Tour Guide
    const HISTORY_KEYWORDS = ['ch√πa', 'ƒë√¨nh', 'ƒë·ªÅn', 'mi·∫øu', 'nh√† th·ªù', 'di t√≠ch', 'l·ªãch s·ª≠', 'b·∫£o t√†ng', 'lƒÉng', 't·∫©m', 'th√°p', 'c·ªïng', 'vƒÉn mi·∫øu', 'qu·ªëc t·ª≠ gi√°m'];

    // DOM Elements
    const elSpeed = document.getElementById('current-speed');
    const elLimit = document.getElementById('speed-limit');
    const elSpeedPanel = document.getElementById('speed-panel');
    const elNavPanel = document.getElementById('nav-panel');
    const elNavIcon = document.getElementById('nav-icon');
    const elNavInstr = document.getElementById('nav-instruction');
    const elNavDist = document.getElementById('nav-distance');
    const elLaneHint = document.getElementById('lane-hint');
    const elStoryPanel = document.getElementById('story-panel');
    const elStoryText = document.getElementById('story-text');
    const listEl = document.getElementById('places-list');

    // --- 1. VEHICLE & UTILS ---
    function setVehicle(type) {
        vehicleType = type;
        document.getElementById('opt-car').className = `vehicle-option ${type === 'car' ? 'active' : ''}`;
        document.getElementById('opt-bike').className = `vehicle-option ${type === 'bike' ? 'active' : ''}`;
        document.getElementById('vehicle-label').innerText = type === 'car' ? '√î t√¥' : 'Xe m√°y';
        document.getElementById('vehicle-icon').innerText = type === 'car' ? 'üöó' : 'üèçÔ∏è';
        elLimit.innerText = "--";
        currentSpeedLimit = null;
    }
    
    function updateStatus(msg) { document.getElementById('status').innerText = msg; }
    
    // --- 2. CORE GPS LOOP ---
    function initLocation() {
        if (!navigator.geolocation) return updateStatus("Kh√¥ng h·ªó tr·ª£ GPS");
        
        navigator.geolocation.watchPosition(
            (pos) => {
                currentLat = pos.coords.latitude;
                currentLon = pos.coords.longitude;
                const speedKmh = Math.round((pos.coords.speed || 0) * 3.6);
                
                // Map Update
                if (!userMarker) {
                    userMarker = L.marker([currentLat, currentLon], {zIndexOffset: 1000}).addTo(map);
                    map.setView([currentLat, currentLon], 16);
                } else {
                    userMarker.setLatLng([currentLat, currentLon]);
                }
                elSpeed.innerText = speedKmh;

                // MAIN LOGIC LOOP
                if (isTourActive) {
                    checkSpeedLimit(speedKmh, currentLat, currentLon);
                    updateNavigation(currentLat, currentLon);
                    checkTourGuideProximity(currentLat, currentLon);
                }
            },
            (err) => console.error(err),
            { enableHighAccuracy: true, maximumAge: 1000 }
        );
    }
    initLocation();

    // --- 3. SAFETY: SPEED LIMIT ---
    async function checkSpeedLimit(currentSpeed, lat, lon) {
        const now = Date.now();
        if (now - lastOverpassCall > 15000) { // G·ªçi API m·ªói 15s
            lastOverpassCall = now;
            const query = `[out:json];way(around:25, ${lat}, ${lon})["maxspeed"];out tags;`;
            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data.elements && data.elements.length > 0) {
                    let rawLimit = parseInt(data.elements[0].tags.maxspeed);
                    if (!isNaN(rawLimit)) {
                        // Logic xe m√°y (Max 70km/h)
                        if (vehicleType === 'bike' && rawLimit > 70) currentSpeedLimit = 70;
                        else currentSpeedLimit = rawLimit;
                        elLimit.innerText = currentSpeedLimit;
                    } else {
                        currentSpeedLimit = null;
                        elLimit.innerText = "--";
                    }
                }
            } catch (e) {}
        }

        if (currentSpeedLimit && currentSpeed > currentSpeedLimit + 5) {
            elSpeedPanel.classList.add('warning');
            if (!synth.speaking) speak("B·∫°n ƒëang qu√° t·ªëc ƒë·ªô!", true);
        } else {
            elSpeedPanel.classList.remove('warning');
        }
    }

    // --- 4. NAVIGATION: TURN-BY-TURN ---
    function updateNavigation(lat, lon) {
        if (!routeSteps || nextStepIndex >= routeSteps.length) return;

        const nextStep = routeSteps[nextStepIndex];
        const stepLoc = nextStep.maneuver.location; 
        const distToStep = getDist(lat, lon, stepLoc[1], stepLoc[0]);

        elNavDist.innerText = distToStep < 1000 ? Math.round(distToStep) + " m" : (distToStep/1000).toFixed(1) + " km";

        if (distToStep < 30) {
            nextStepIndex++; // ƒê√£ qua ƒëi·ªÉm r·∫Ω
            updateNavigation(lat, lon);
            return;
        }

        const modifier = nextStep.maneuver.modifier; 
        const type = nextStep.maneuver.type;
        
        let icon = "‚¨ÜÔ∏è";
        let instruction = "ƒêi th·∫≥ng";
        let laneMsg = "";

        if (type === 'turn' || type === 'roundabout') {
            if (modifier && modifier.includes('right')) {
                icon = "‚û°Ô∏è"; instruction = "R·∫Ω ph·∫£i";
                if (distToStep < 300) laneMsg = "üí° ƒêi l√†n b√™n ph·∫£i";
                // ∆Øu ti√™n ƒë·ªçc h∆∞·ªõng d·∫´n r·∫Ω n·∫øu g·∫ßn
                if (distToStep < 150 && distToStep > 100) speak("S·∫Øp r·∫Ω ph·∫£i, ƒëi l√†n ph·∫£i.", true);
            } else if (modifier && modifier.includes('left')) {
                icon = "‚¨ÖÔ∏è"; instruction = "R·∫Ω tr√°i";
                if (distToStep < 300) laneMsg = "üí° ƒêi l√†n b√™n tr√°i";
                if (distToStep < 150 && distToStep > 100) speak("S·∫Øp r·∫Ω tr√°i, ƒëi l√†n tr√°i.", true);
            }
        } else if (type === 'arrive') {
            icon = "üèÅ"; instruction = "S·∫Øp ƒë·∫øn ƒë√≠ch";
        }

        elNavIcon.innerText = icon;
        elNavInstr.innerText = instruction;
        elLaneHint.innerText = laneMsg;
    }

    // --- 5. TOUR GUIDE: FETCH & PLAY ---
    
    // B∆∞·ªõc A: T√¨m ƒë∆∞·ªùng & T·∫°o ƒëi·ªÉm qu√©t
    async function searchDestination() {
        const query = document.getElementById('destination-input').value;
        if (!query) return alert("Nh·∫≠p ƒëi·ªÉm ƒë·∫øn!");
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=vn&limit=1`);
        const data = await res.json();
        if (data.length === 0) return updateStatus("Kh√¥ng t√¨m th·∫•y.");
        const dest = data[0];
        
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker([dest.lat, dest.lon]).addTo(map).bindPopup("ƒê√≠ch").openPopup();
        map.fitBounds(L.featureGroup([userMarker, destMarker]).getBounds().pad(0.2));
    }

    async function calculateRouteAndScan() {
        if (!destMarker) return alert("Vui l√≤ng ch·ªçn ƒëi·ªÉm ƒë·∫øn.");
        isTourActive = true;
        elNavPanel.style.display = 'flex';
        updateStatus("ƒêang t√≠nh ƒë∆∞·ªùng & t√¨m di t√≠ch...");

        const destPos = destMarker.getLatLng();
        const url = `https://router.project-osrm.org/route/v1/driving/${currentLon},${currentLat};${destPos.lng},${destPos.lat}?overview=full&geometries=geojson&steps=true`;
        
        try {
            const res = await fetch(url);
            const data = await res.json();
            if (data.code !== 'Ok') return updateStatus("L·ªói ƒë∆∞·ªùng ƒëi.");
            
            // Setup Nav
            const route = data.routes[0];
            routeSteps = route.legs[0].steps;
            nextStepIndex = 1;
            
            // Draw Map
            const latLngs = route.geometry.coordinates.map(c => [c[1], c[0]]);
            if (routePolyline) map.removeLayer(routePolyline);
            routePolyline = L.polyline(latLngs, {color: '#0d6efd', weight: 6}).addTo(map);
            map.fitBounds(routePolyline.getBounds());
            
            // Trigger Scan
            generateScanPointsAndFetch(latLngs);
            speak(`B·∫Øt ƒë·∫ßu h√†nh tr√¨nh. T√¥i s·∫Ω v·ª´a d·∫´n ƒë∆∞·ªùng v·ª´a thuy·∫øt minh v·ªÅ c√°c di t√≠ch tr√™n ƒë∆∞·ªùng ƒëi.`, true);

        } catch (e) { updateStatus("L·ªói k·∫øt n·ªëi."); }
    }

    // B∆∞·ªõc B: Qu√©t Wiki d·ªçc ƒë∆∞·ªùng
    async function generateScanPointsAndFetch(pathCoords) {
        // L·∫•y m·∫´u ƒëi·ªÉm tr√™n ƒë∆∞·ªùng ƒëi ƒë·ªÉ qu√©t (c·ª© m·ªói ~1km l·∫•y 1 ƒëi·ªÉm)
        // OSRM tr·∫£ v·ªÅ r·∫•t nhi·ªÅu ƒëi·ªÉm, ta l·∫•y m·∫´u b∆∞·ªõc nh·∫£y (step)
        const samplePoints = [];
        const step = Math.max(30, Math.floor(pathCoords.length / 15)); 
        
        for(let i=0; i<pathCoords.length; i+=step) {
            samplePoints.push({lat: pathCoords[i][0], lon: pathCoords[i][1]});
        }
        // Th√™m ƒëi·ªÉm cu·ªëi
        samplePoints.push({lat: pathCoords[pathCoords.length-1][0], lon: pathCoords[pathCoords.length-1][1]});

        updateStatus(`ƒêang qu√©t d·ªØ li·ªáu l·ªãch s·ª≠ t·∫°i ${samplePoints.length} khu v·ª±c d·ªçc l·ªô tr√¨nh...`);
        
        let allResults = new Map();
        
        // Fetch song song
        const promises = samplePoints.map(pt => 
            fetch(`https://vi.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${pt.lat}|${pt.lon}&gsradius=1500&gslimit=10&format=json&origin=*`)
            .then(r => r.json())
        );
        
        const responses = await Promise.all(promises);
        
        // G·ªôp ID
        let pageIds = [];
        responses.forEach(data => {
            if(data.query && data.query.geosearch) {
                data.query.geosearch.forEach(p => {
                    if (!allResults.has(p.pageid)) {
                        allResults.set(p.pageid, p);
                        pageIds.push(p.pageid);
                    }
                });
            }
        });

        if (pageIds.length === 0) return updateStatus("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm n·ªïi ti·∫øng n√†o.");

        // L·∫•y chi ti·∫øt (Extracts) - Chia nh·ªè n·∫øu qu√° nhi·ªÅu
        // Wiki API gi·ªõi h·∫°n kho·∫£ng 50 ID 1 l·∫ßn, ·ªü ƒë√¢y l√†m ƒë∆°n gi·∫£n l·∫•y 50 ƒë·∫ßu ti√™n
        const limitedIds = pageIds.slice(0, 50).join('|');
        fetch(`https://vi.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&pageids=${limitedIds}&format=json&origin=*`)
            .then(r => r.json())
            .then(data => {
                const pages = data.query.pages;
                
                // X·ª≠ l√Ω v√† l·ªçc
                placesQueue = Array.from(allResults.values()).map(p => {
                    if (!pages[p.pageid]) return null;
                    const details = pages[p.pageid];
                    const text = (p.title + " " + (details.extract || "")).toLowerCase();
                    const isPriority = HISTORY_KEYWORDS.some(k => text.includes(k));
                    
                    // Ch·ªâ l·∫•y n·∫øu l√† L·ªãch s·ª≠ HO·∫∂C c√≥ m√¥ t·∫£ ƒë·ªß d√†i
                    if (!isPriority && (!details.extract || details.extract.length < 50)) return null;

                    return {
                        id: p.pageid,
                        title: p.title,
                        lat: p.lat,
                        lon: p.lon,
                        extract: details.extract || "Kh√¥ng c√≥ m√¥ t·∫£.",
                        isPriority: isPriority
                    };
                }).filter(p => p !== null); // B·ªè null

                updateStatus(`ƒê√£ t√¨m th·∫•y ${placesQueue.length} ƒë·ªãa ƒëi·ªÉm th√∫ v·ªã.`);
                renderPlacesList();
            });
    }

    function renderPlacesList() {
        listEl.innerHTML = "";
        placesQueue.forEach(p => {
            const li = document.createElement('li');
            li.className = `place-card ${p.isPriority ? 'priority' : ''}`;
            li.id = `place-${p.id}`;
            li.innerHTML = `
                <div class="place-header">
                    <span class="place-title">${p.title} <span class="place-badge">Di t√≠ch</span></span>
                </div>
                <div class="place-desc">${p.extract}</div>
            `;
            listEl.appendChild(li);
        });
    }

    // B∆∞·ªõc C: Ki·ªÉm tra v·ªã tr√≠ ƒë·ªÉ ƒë·ªçc (Trigger Logic)
    function checkTourGuideProximity(lat, lon) {
        if (synth.speaking) return; // N·∫øu ƒëang n√≥i th√¨ th√¥i

        let nearest = null;
        let minDesc = 99999;

        placesQueue.forEach(p => {
            if (alreadyReadIds.includes(p.id)) return;

            const dist = getDist(lat, lon, p.lat, p.lon);
            
            // N·∫øu v√†o v√πng b√°n k√≠nh 400m
            if (dist < 400) {
                if (dist < minDesc) {
                    minDesc = dist;
                    nearest = p;
                }
            }
        });

        if (nearest) {
            alreadyReadIds.push(nearest.id);
            // Highlight UI
            document.querySelectorAll('.place-card').forEach(e => e.classList.remove('active'));
            const card = document.getElementById(`place-${nearest.id}`);
            if(card) {
                card.classList.add('active');
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Show Panel & Speak
            elStoryPanel.style.display = 'flex';
            elStoryText.innerText = `ƒêang ƒë·ªçc: ${nearest.title}`;
            
            const intro = nearest.isPriority ? "B√™n c·∫°nh c√≥ di t√≠ch l·ªãch s·ª≠. " : "S·∫Øp ƒëi qua. ";
            speak(`${intro} ${nearest.title}. ${nearest.extract}`, false);
        }
    }

    // --- UTILS ---
    function speak(text, isUrgent) {
        // N·∫øu tin kh·∫©n c·∫•p (C·∫£nh b√°o/R·∫Ω) -> H·ªßy c√°i ƒëang ƒë·ªçc ƒë·ªÉ n√≥i ngay
        if (isUrgent) {
            synth.cancel();
            elStoryPanel.style.display = 'none';
        }
        
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'vi-VN';
        u.rate = 1.0;
        
        u.onend = () => {
            if (!isUrgent) elStoryPanel.style.display = 'none';
        };
        
        synth.speak(u);
    }

    function stopTour() {
        isTourActive = false;
        synth.cancel();
        elNavPanel.style.display = 'none';
        elStoryPanel.style.display = 'none';
        updateStatus("ƒê√£ d·ª´ng h√†nh tr√¨nh.");
    }

    function getDist(lat1,lon1,lat2,lon2) {
        var R=6371000; var dLat=(lat2-lat1)*Math.PI/180; var dLon=(lon2-lon1)*Math.PI/180;
        var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
</script>

</body>
</html>
