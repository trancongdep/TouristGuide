<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>H∆∞·ªõng D·∫´n Vi√™n ·∫¢o</title>
    <meta name="theme-color" content="#0d6efd">
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        header {
            background-color: #0d6efd;
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 1.2rem; }
        .controls {
            background: white;
            padding: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            border-bottom: 1px solid #ddd;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-scan { background-color: #198754; color: white; flex: 1; }
        .btn-stop { background-color: #dc3545; color: white; }
        
        #status {
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }
        
        #places-list {
            padding: 15px;
            list-style: none;
            margin: 0;
        }
        
        .place-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid #ddd;
            transition: transform 0.2s;
        }
        .place-card.active {
            border-left-color: #0d6efd;
            background-color: #e7f1ff;
        }
        .place-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            display: block;
        }
        .place-dist {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 8px;
            display: block;
        }
        .place-desc {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .speaking-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #dc3545;
            border-radius: 50%;
            margin-left: 5px;
            animation: pulse 1s infinite;
            display: none;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
    </style>
</head>
<body>

<header>
    <h1>H∆∞·ªõng D·∫´n Vi√™n ·∫¢o <span id="version" style="font-size:0.7em; opacity:0.8">v1.0</span></h1>
</header>

<div class="controls">
    <button class="btn-scan" onclick="startTour()">üîÑ Qu√©t & Thuy·∫øt minh</button>
    <button class="btn-stop" onclick="stopTour()">‚èπ D·ª´ng</button>
</div>

<div id="status">ƒêang ch·ªù l·ªánh...</div>

<ul id="places-list">
    </ul>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
    authDomain: "tavietnam-78ae8.firebaseapp.com",
    projectId: "tavietnam-78ae8",
    storageBucket: "tavietnam-78ae8.firebasestorage.app",
    messagingSenderId: "670121705534",
    appId: "1:670121705534:web:1027ad98550573ad37116f"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  console.log("Firebase initialized");
</script>

<script>
    // --- Logic ·ª®ng d·ª•ng ---
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('places-list');
    let synth = window.speechSynthesis;
    let currentUtterance = null;
    let placesQueue = [];
    let isSpeaking = false;

    // ƒêƒÉng k√Ω Service Worker cho PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker failed', err));
        });
    }

    function updateStatus(msg) {
        statusEl.textContent = msg;
    }

    function stopTour() {
        synth.cancel();
        isSpeaking = false;
        placesQueue = [];
        updateStatus("ƒê√£ d·ª´ng thuy·∫øt minh.");
        document.querySelectorAll('.speaking-indicator').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.place-card').forEach(el => el.classList.remove('active'));
    }

    function startTour() {
        stopTour(); // Reset tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu m·ªõi
        updateStatus("ƒêang ƒë·ªãnh v·ªã...");
        listEl.innerHTML = '';

        if (!navigator.geolocation) {
            updateStatus("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                updateStatus(`ƒê√£ t√¨m th·∫•y v·ªã tr√≠. ƒêang qu√©t ƒë·ªãa ƒëi·ªÉm...`);
                fetchNearbyPlaces(lat, lon);
            },
            (error) => {
                updateStatus("L·ªói ƒë·ªãnh v·ªã: " + error.message);
            },
            { enableHighAccuracy: true }
        );
    }

    // S·ª≠ d·ª•ng Wikipedia API ƒë·ªÉ t√¨m ƒë·ªãa danh xung quanh
    async function fetchNearbyPlaces(lat, lon) {
        // B√°n k√≠nh 1000m, l·∫•y 10 ƒë·ªãa ƒëi·ªÉm g·∫ßn nh·∫•t
        const url = `https://vi.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}|${lon}&gsradius=1000&gslimit=10&format=json&origin=*`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (!data.query || !data.query.geosearch || data.query.geosearch.length === 0) {
                updateStatus("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm n·ªïi ti·∫øng n√†o g·∫ßn ƒë√¢y.");
                return;
            }

            const places = data.query.geosearch;
            // L·∫•y th√¥ng tin chi ti·∫øt cho t·ª´ng ƒë·ªãa ƒëi·ªÉm
            const placeIds = places.map(p => p.pageid).join('|');
            fetchPlaceDetails(placeIds, places);

        } catch (e) {
            updateStatus("L·ªói k·∫øt n·ªëi API Wikipedia.");
            console.error(e);
        }
    }

    async function fetchPlaceDetails(ids, originalPlaces) {
        const url = `https://vi.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&pageids=${ids}&format=json&origin=*`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            const pages = data.query.pages;

            // K·∫øt h·ª£p d·ªØ li·ªáu kho·∫£ng c√°ch v√† n·ªôi dung
            let results = originalPlaces.map(place => {
                const details = pages[place.pageid];
                return {
                    id: place.pageid,
                    title: place.title,
                    dist: place.dist, // Kho·∫£ng c√°ch t√≠nh b·∫±ng m√©t
                    extract: details ? details.extract : "Kh√¥ng c√≥ m√¥ t·∫£."
                };
            });

            // S·∫Øp x·∫øp theo kho·∫£ng c√°ch
            results.sort((a, b) => a.dist - b.dist);

            renderPlaces(results);
            startReadingQueue(results);

        } catch (e) {
            updateStatus("L·ªói l·∫•y chi ti·∫øt ƒë·ªãa ƒëi·ªÉm.");
        }
    }

    function renderPlaces(places) {
        updateStatus(`T√¨m th·∫•y ${places.length} ƒë·ªãa ƒëi·ªÉm. ƒêang thuy·∫øt minh...`);
        places.forEach(place => {
            const li = document.createElement('li');
            li.className = 'place-card';
            li.id = `place-${place.id}`;
            li.innerHTML = `
                <span class="place-title">${place.title} <span class="speaking-indicator"></span></span>
                <span class="place-dist">C√°ch ƒë√¢y ${Math.round(place.dist)}m</span>
                <div class="place-desc">${truncateText(place.extract, 150)}</div>
            `;
            listEl.appendChild(li);
        });
    }

    function truncateText(text, length) {
        if (!text) return "";
        return text.length > length ? text.substring(0, length) + "..." : text;
    }

    function startReadingQueue(places) {
        // ƒê·ªçc l·ªùi ch√†o m·ªü ƒë·∫ßu
        speak("T√¥i ƒë√£ t√¨m th·∫•y c√°c ƒë·ªãa ƒëi·ªÉm sau ƒë√¢y. B·∫Øt ƒë·∫ßu thuy·∫øt minh.", null);

        places.forEach(place => {
            // L·ªçc b·ªõt c√°c k√Ω t·ª± l·∫° ho·∫∑c n·ªôi dung qu√° ng·∫Øn
            if(place.extract && place.extract.length > 20) {
                const textToRead = `ƒê·ªãa ƒëi·ªÉm: ${place.title}. C√°ch b·∫°n ${Math.round(place.dist)} m√©t. ${place.extract}`;
                speak(textToRead, place.id);
            }
        });
    }

    function speak(text, placeId) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'vi-VN'; // Gi·ªçng ti·∫øng Vi·ªát
        utterance.rate = 1.0; // T·ªëc ƒë·ªô ƒë·ªçc

        utterance.onstart = () => {
            if (placeId) {
                // Highlight UI
                document.querySelectorAll('.place-card').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.speaking-indicator').forEach(el => el.style.display = 'none');
                
                const card = document.getElementById(`place-${placeId}`);
                if (card) {
                    card.classList.add('active');
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const indicator = card.querySelector('.speaking-indicator');
                    if (indicator) indicator.style.display = 'inline-block';
                }
            }
        };

        utterance.onend = () => {
             if (placeId) {
                const card = document.getElementById(`place-${placeId}`);
                if (card) {
                    card.classList.remove('active');
                    card.querySelector('.speaking-indicator').style.display = 'none';
                }
             }
        };

        synth.speak(utterance);
    }
</script>

</body>
</html>
